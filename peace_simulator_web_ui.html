<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ•Šï¸ Interactive Peace Simulator - 1937 ä¸­æ—¥å±æ©Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .setup-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .role-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .role-card {
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .role-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .role-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .role-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .role-description {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .setting-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .setting-group h3 {
            margin-bottom: 15px;
            color: #333;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .mode-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .mode-option {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .mode-option.active {
            background: #667eea;
            color: white;
        }

        .start-button {
            width: 100%;
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .start-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .simulation-area {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .player-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: bold;
        }

        .metrics-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #28a745;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .situation-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .situation-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .decision-panel {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .decision-title {
            font-weight: bold;
            color: #0c5460;
            margin-bottom: 15px;
        }

        .decision-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .decision-option {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .decision-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .decision-option.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .decision-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 15px;
        }

        .submit-decision {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .submit-decision:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .events-log {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .event-item {
            padding: 10px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
        }

        .event-time {
            font-size: 0.8rem;
            color: #666;
        }

        .dev-panel {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-family: monospace;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes progressAnimation {
            0% { width: 0%; }
            50% { width: 60%; }
            80% { width: 85%; }
            100% { width: 95%; }
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .role-selection {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-panel {
                grid-template-columns: 1fr 1fr;
            }
            
            .decision-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ•Šï¸ Interactive Peace Simulator</h1>
            <div class="subtitle">1937å¹´ä¸­æ—¥å±æ©Ÿ - ä½ èƒ½é˜»æ­¢æˆ°çˆ­å—ï¼Ÿ</div>
            <p>é«”é©—æ­·å²è½‰æŠ˜é»ï¼Œé‹ç”¨å¤–äº¤æ™ºæ…§åŒ–è§£å±æ©Ÿï¼Œé¿å…å…¨é¢æˆ°çˆ­çš„çˆ†ç™¼</p>
        </div>

        <!-- Setup Panel -->
        <div class="setup-panel" id="setupPanel">
            <h2 style="margin-bottom: 30px; text-align: center;">ğŸ­ é¸æ“‡æ‚¨çš„è§’è‰²èˆ‡è¨­å®š</h2>
            
            <!-- Role Selection -->
            <div class="role-selection">
                <div class="role-card" data-role="emperor">
                    <div class="role-icon">ğŸ‘‘</div>
                    <div class="role-title">æ˜­å’Œå¤©çš‡</div>
                    <div class="role-description">
                        ç¥è–ä¸å¯ä¾µçŠ¯çš„æ—¥æœ¬å¤©çš‡ï¼Œæ“æœ‰è‡³é«˜ç„¡ä¸Šçš„é“å¾·å¨æœ›ã€‚
                        æ‚¨éœ€è¦åœ¨è»éƒ¨å£“åŠ›èˆ‡å’Œå¹³ç†æƒ³é–“å–å¾—å¹³è¡¡ï¼Œé‹ç”¨å¸ç‹æ¬Šå¨é˜»æ­¢æˆ°çˆ­ã€‚
                    </div>
                </div>
                <div class="role-card" data-role="chiang">
                    <div class="role-icon">ğŸ‡¨ğŸ‡³</div>
                    <div class="role-title">è”£ä¸­æ­£</div>
                    <div class="role-description">
                        ä¸­è¯æ°‘åœ‹é ˜è¢–ï¼Œé¢è‡¨æ—¥æœ¬ä¾µç•¥å¨è„…ã€‚
                        æ‚¨å¿…é ˆåœ¨ç¶­è­·åœ‹å®¶ä¸»æ¬Šèˆ‡é¿å…å…¨é¢æˆ°çˆ­é–“åšå‡ºè‰±é›£æŠ‰æ“‡ï¼Œä¿è­·ä¸­åœ‹äººæ°‘ã€‚
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="settings-grid">
                <div class="setting-group">
                    <h3>ğŸ¤– AI æ¨¡å‹é¸æ“‡</h3>
                    <select id="modelSelect">
                        <option value="gemini/gemini-2.0-flash">Gemini 2 Flash (æ¨è–¦)</option>
                        <option value="groq/meta-llama/llama-4-scout-17b-16e-instruct">Groq Llama 4 Scout </option>
                        <option value="groq/llama-3.1-8b-instant">Groq Llama 3.1 8B (å¿«é€Ÿ)</option>
                        <option value="gpt-4">OpenAI GPT-4</option>
                        <option value="claude-3">Anthropic Claude-3</option>
                    </select>
                </div>

                <div class="setting-group">
                    <h3>â±ï¸ æœ€å¤§å›åˆæ•¸</h3>
                    <input type="number" id="maxTurns" value="120" min="12" max="120">
                </div>
            </div>

            <div class="setting-group">
                <h3>ğŸ” æ¨¡æ“¬æ¨¡å¼</h3>
                <div class="mode-toggle">
                    <div class="mode-option active" data-mode="default">
                        <div>ğŸ‘ï¸ é»˜èªæ¨¡å¼</div>
                        <small>çœŸå¯¦è¦–è§’ï¼Œåªçœ‹åˆ°è§’è‰²å¯ç²å¾—çš„ä¿¡æ¯</small>
                    </div>
                    <div class="mode-option" data-mode="dev">
                        <div>ğŸ” é–‹ç™¼è€…æ¨¡å¼</div>
                        <small>å…¨é€æ˜ï¼Œå¯è¦‹æ‰€æœ‰è§’è‰²çš„æƒ³æ³•å’Œè¨ˆåŠƒ</small>
                    </div>
                </div>
            </div>

            <button class="start-button" id="startSimulation" disabled>
                ğŸš€ é–‹å§‹å’Œå¹³æ¨¡æ“¬
            </button>
        </div>

        <!-- Simulation Area -->
        <div class="simulation-area" id="simulationArea">
            <!-- Game Header -->
            <div class="game-header">
                <div class="player-info" id="playerInfo">
                    <div>è§’è‰²ï¼šæœªé¸æ“‡</div>
                    <div>å›åˆï¼š0/0</div>
                </div>
                <div class="player-info" id="modeInfo">
                    æ¨¡å¼ï¼šæœªè¨­å®š
                </div>
            </div>

            <!-- Peace Metrics -->
            <div class="metrics-panel" id="metricsPanel">
                <div class="metric-card">
                    <div class="metric-value" id="peaceScore">100</div>
                    <div class="metric-label">å’Œå¹³åˆ†æ•¸</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="peaceProgress" style="width: 100%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="diplomacyScore">0</div>
                    <div class="metric-label">å¤–äº¤æˆåŠŸ</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="diplomacyProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="reputationScore">50</div>
                    <div class="metric-label">åœ‹éš›è²æœ›</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="reputationProgress" style="width: 50%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="stabilityScore">50</div>
                    <div class="metric-label">å…§éƒ¨ç©©å®š</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="stabilityProgress" style="width: 50%"></div>
                    </div>
                </div>
                <div class="metric-card" style="border-left-color: #dc3545;">
                    <div class="metric-value" id="warIntentionScore">50</div>
                    <div class="metric-label">æˆ°çˆ­å‚¾å‘</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="warIntentionProgress" style="width: 50%; background: linear-gradient(45deg, #ffc107, #dc3545);"></div>
                    </div>
                </div>
            </div>

            <!-- Current Situation -->
            <div class="situation-panel" id="situationPanel">
                <div class="situation-title">
                    ğŸš¨ ç•¶å‰å±€å‹¢
                </div>
                <div id="currentSituation">
                    æ­£åœ¨åŠ è¼‰æƒ…æ³åˆ†æ...
                </div>
            </div>

            <!-- Decision Panel -->
            <div class="decision-panel" id="decisionPanel" style="display: none;">
                <div class="decision-title">
                    ğŸ¤” æ‚¨çš„æ±ºç­–æ™‚åˆ»
                </div>
                <div id="decisionDescription">
                    è«‹é¸æ“‡æ‚¨çš„è¡Œå‹•æ–¹é‡...
                </div>
                
                <div class="decision-options" id="decisionOptions">
                    <!-- Options will be dynamically generated based on role -->
                </div>

                <textarea class="decision-input" id="decisionInput"
                          placeholder="èªªæ˜æ‚¨çš„æ±ºç­–ç†ç”±...&#10;&#10;æ³¨æ„ï¼šæ­¤å…§å®¹åƒ…ä¾›è¨˜éŒ„ï¼Œä¸æœƒå½±éŸ¿å…¶ä»–ç©å®¶ã€‚"></textarea>

                <button class="submit-decision" id="submitDecision">
                    âœ… ç¢ºèªæ±ºç­–
                </button>
            </div>

            <!-- Events Log -->
            <div class="events-log" id="eventsLog">
                <h3>ğŸ“‹ äº‹ä»¶è¨˜éŒ„</h3>
                <div id="eventsList">
                    <div class="event-item">
                        <div class="event-time" id="initialEventDate">1930å¹´1æœˆ</div>
                        <div id="initialEventDescription">ç¶“æ¿Ÿå¤§è•­æ¢å½±éŸ¿äºæ´²ï¼Œæ—¥æœ¬è»åœ‹ä¸»ç¾©æŠ¬é ­</div>
                    </div>
                </div>
            </div>

            <!-- Dev Panel (only visible in dev mode) -->
            <div class="dev-panel" id="devPanel" style="display: none;">
                <h3>ğŸ” é–‹ç™¼è€…æ¨¡å¼ - AI ä»£ç†æ€ç¶­éç¨‹</h3>
                <div id="devOutput">
                    ç­‰å¾… AI ä»£ç†åˆ†æ...
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loadingState" style="display: none;">
                <div class="spinner"></div>
                <div id="loadingMessage">AI æ­£åœ¨åˆ†æå±€å‹¢ä¸¦åˆ¶å®šå›æ‡‰...</div>
                <div id="currentPlayerThinking" style="font-size: 1.1rem; color: #667eea; margin-top: 10px; font-weight: bold;"></div>
                <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                    é€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å¾…
                </div>
                <div class="progress-bar" style="width: 80%; margin: 20px auto 0;">
                    <div class="progress-fill" id="loadingProgress" style="width: 0%; animation: progressAnimation 15s ease-in-out;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let gameState = {
            selectedRole: null,
            selectedMode: 'default',
            selectedModel: 'groq/llama3-70b-8192',
            maxTurns: 120,  // 10 years * 12 months (1930-1940)
            startYear: 1930,
            currentTurn: 0,
            isSimulationRunning: false,
            currentDecision: null,
            historicalEvents: [],
            warIntention: 50,  // 0=peace, 100=total war (BDM calculated)
            emperorInfluence: 30,  // Emperor's influence level
            factionStates: {},  // Detailed faction positions
            metrics: {
                peace: 80,
                diplomacy: 0,
                reputation: 30,
                stability: 20
            }
        };

        // Initialize UI
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            checkAPIConfiguration();
        });

        function initializeEventListeners() {
            // Role selection
            document.querySelectorAll('.role-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectRole(this.dataset.role);
                });
            });

            // Mode selection
            document.querySelectorAll('.mode-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectMode(this.dataset.mode);
                });
            });

            // Settings
            document.getElementById('modelSelect').addEventListener('change', function() {
                gameState.selectedModel = this.value;
            });

            document.getElementById('maxTurns').addEventListener('change', function() {
                gameState.maxTurns = parseInt(this.value);
            });

            // Start simulation
            document.getElementById('startSimulation').addEventListener('click', startSimulation);

            // Decision options
            document.querySelectorAll('.decision-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectDecisionOption(this.dataset.option);
                });
            });

            // Submit decision
            document.getElementById('submitDecision').addEventListener('click', submitDecision);
        }

        function selectRole(role) {
            gameState.selectedRole = role;
            
            // Update UI
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.role === role);
            });

            checkStartConditions();
        }

        function selectMode(mode) {
            gameState.selectedMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.toggle('active', option.dataset.mode === mode);
            });
        }

        function selectDecisionOption(option) {
            gameState.currentDecision = option;
            
            // Update UI
            document.querySelectorAll('.decision-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.option === option);
            });
        }

        function checkStartConditions() {
            const canStart = gameState.selectedRole !== null;
            document.getElementById('startSimulation').disabled = !canStart;
        }

        function checkAPIConfiguration() {
            // In a real implementation, this would check if API keys are configured
            // For demo purposes, we'll assume they're available
            console.log('Checking API configuration...');
        }

        function startSimulation() {
            if (!gameState.selectedRole) {
                alert('è«‹å…ˆé¸æ“‡è§’è‰²ï¼');
                return;
            }

            gameState.isSimulationRunning = true;
            gameState.currentTurn = 0;

            // Hide setup panel and show simulation
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('simulationArea').style.display = 'block';

            // Update player info
            const roleNames = {
                emperor: 'æ˜­å’Œå¤©çš‡',
                chiang: 'è”£ä¸­æ­£'
            };
            
            const modeNames = {
                default: 'é»˜èªæ¨¡å¼',
                dev: 'é–‹ç™¼è€…æ¨¡å¼'
            };

            document.getElementById('playerInfo').innerHTML = `
                <div>è§’è‰²ï¼š${roleNames[gameState.selectedRole]}</div>
                <div>å›åˆï¼š${gameState.currentTurn}/${gameState.maxTurns}</div>
            `;
            document.getElementById('modeInfo').textContent = `æ¨¡å¼ï¼š${modeNames[gameState.selectedMode]}`;

            // Show dev panel if in dev mode
            if (gameState.selectedMode === 'dev') {
                document.getElementById('devPanel').style.display = 'block';
            }

            // Start first turn
            startNewTurn();
        }

        function startNewTurn() {
            gameState.currentTurn++;

            // Update turn counter
            const roleNames = {
                emperor: 'æ˜­å’Œå¤©çš‡',
                chiang: 'è”£ä¸­æ­£'
            };

            document.getElementById('playerInfo').innerHTML = `
                <div>è§’è‰²ï¼š${roleNames[gameState.selectedRole]}</div>
                <div>å›åˆï¼š${gameState.currentTurn}/${gameState.maxTurns}</div>
            `;

            // Show loading state with current turn info
            showLoading(true, true);

            // Simulate AI analysis (in real implementation, this would call the backend)
            setTimeout(() => {
                generateSituationUpdate();
                showLoading(false);
                showDecisionPanel();
            }, 3000);
        }

        function generateSituationUpdate() {
            const situations = {
                emperor: [
                    "è»éƒ¨å°‡é ˜è¦æ±‚æ‚¨æ‰¹å‡†å°è¯åŒ—çš„é€²ä¸€æ­¥è»äº‹è¡Œå‹•ï¼Œè²ç¨±é€™æ˜¯ç¶­è­·å¸åœ‹å°Šåš´çš„å¿…è¦æªæ–½ã€‚åŒæ™‚ï¼Œåœ‹éš›è§€å¯Ÿå®¶è­¦å‘Šæ­¤èˆ‰å¯èƒ½å¼•ç™¼å…¨é¢æˆ°çˆ­ã€‚",
                    "é—œæ±è»å ±å‘Šä¸­åœ‹è»éšŠåœ¨è¯åŒ—é›†çµï¼Œè¦æ±‚é å…ˆæ‰¹å‡†è‡ªè¡›åæ“Šã€‚å¤–å‹™çœå»ºè­°é€éå¤–äº¤é€”å¾‘è§£æ±ºï¼Œä½†è»éƒ¨èªç‚ºå¤–äº¤æ‰‹æ®µéæ–¼è»Ÿå¼±ã€‚",
                    "åœ‹éš›è¯ç›Ÿå‘¼ç±²é›™æ–¹å…‹åˆ¶ï¼Œç¾åœ‹è¡¨é”é—œåˆ‡ã€‚è»éƒ¨èªç‚ºé€™æ˜¯è¥¿æ–¹å‹¢åŠ›å¹²æ¶‰ï¼Œä½†ä¹Ÿæœ‰é¡§å•å»ºè­°é€™æ˜¯å±•ç¾æ—¥æœ¬å’Œå¹³æ„é¡˜çš„æ©Ÿæœƒã€‚"
                ],
                chiang: [
                    "æ—¥è»åœ¨è¯åŒ—èª¿å‹•é »ç¹ï¼Œåœ°æ–¹æŒ‡æ®å®˜è«‹æ±‚ä¸­å¤®æ”¿åºœæ˜ç¢ºæŒ‡ç¤ºã€‚å…±ç”¢é»¨æ–¹é¢è¡¨ç¤ºé¡˜æ„æš«æ™‚åˆä½œæŠ—æ—¥ï¼Œä½†æ¢ä»¶æ˜¯åœæ­¢å‰¿å…±ã€‚",
                    "å„åœ°è»é–¥å°æ˜¯å¦æŠµæŠ—æ—¥è»æ„è¦‹åˆ†æ­§ï¼Œæœ‰äº›ä¸»å¼µå¦¥å”ä»¥ä¿å­˜å¯¦åŠ›ï¼Œæœ‰äº›è¦æ±‚å …æ±ºæŠµæŠ—ã€‚åœ‹éš›ç¤¾æœƒçš„æ”¯æŒä»ç„¶æœ‰é™ã€‚",
                    "æ—¥æœ¬æ–¹é¢é‡‹å‡ºå¯èƒ½è«‡åˆ¤çš„ä¿¡è™Ÿï¼Œä½†æ¢ä»¶è‹›åˆ»ã€‚åœ‹å…§è¼¿è«–è¦æ±‚å¼·ç¡¬å›æ‡‰ï¼Œä½†è»äº‹å¯¦åŠ›å·®è·æ˜é¡¯ã€‚"
                ]
            };

            const currentSituations = situations[gameState.selectedRole];
            const situationIndex = (gameState.currentTurn - 1) % currentSituations.length;
            
            document.getElementById('currentSituation').textContent = currentSituations[situationIndex];

            // Add event to log
            addEvent(`ç¬¬${gameState.currentTurn}å›åˆ`, currentSituations[situationIndex]);

            // Simulate dev mode AI thoughts with progressive updates
            if (gameState.selectedMode === 'dev') {
                const devThoughts = [
                    { agent: "Tosei-ha Agent", thought: "åˆ†æç•¶å‰å±€å‹¢ï¼Œå»ºè­°æ¡å–æ¼¸é€²å¼æ§åˆ¶ç­–ç•¥..." },
                    { agent: "Chinese Communist Agent", thought: "è©•ä¼°çµ±ä¸€æˆ°ç·šå¯èƒ½æ€§ï¼Œæº–å‚™ç¾¤çœ¾å‹•å“¡æ–¹æ¡ˆ..." },
                    { agent: "Zaibatsu Agent", thought: "è¨ˆç®—æˆ°çˆ­ç¶“æ¿Ÿæ”¶ç›Šï¼Œè©•ä¼°åœ‹éš›å¸‚å ´é¢¨éšª..." }
                ];

                const devOutput = document.getElementById('devOutput');
                devOutput.innerHTML = '';

                // Show thoughts progressively
                devThoughts.forEach((item, index) => {
                    setTimeout(() => {
                        const thoughtDiv = document.createElement('div');
                        thoughtDiv.style.cssText = "margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; opacity: 0; transition: opacity 0.5s;";
                        thoughtDiv.innerHTML = `<strong>${item.agent}:</strong> ${item.thought}`;
                        devOutput.appendChild(thoughtDiv);
                        // Fade in
                        setTimeout(() => { thoughtDiv.style.opacity = '1'; }, 50);
                    }, index * 500);
                });
            }
        }

        function showDecisionPanel() {
            document.getElementById('decisionPanel').style.display = 'block';
            
            // Update decision description based on role
            const descriptions = {
                emperor: "èº«ç‚ºå¤©çš‡ï¼Œæ‚¨æ“æœ‰è‡³é«˜ç„¡ä¸Šçš„é“å¾·å¨æœ›ã€‚æ‚¨çš„æ±ºå®šå°‡å½±éŸ¿å¸åœ‹çš„æœªä¾†æ–¹å‘ã€‚è«‹æ…é‡è€ƒæ…®å¦‚ä½•é‹ç”¨æ‚¨çš„æ¬Šå¨ä¾†ç¶­è­·å’Œå¹³ã€‚",
                chiang: "ä½œç‚ºä¸­è¯æ°‘åœ‹çš„é ˜è¢–ï¼Œæ‚¨å¿…é ˆåœ¨ç¶­è­·åœ‹å®¶ä¸»æ¬Šèˆ‡é¿å…äººæ°‘å—æˆ°çˆ­ä¹‹è‹¦é–“å–å¾—å¹³è¡¡ã€‚æ‚¨çš„æ±ºç­–é—œä¿‚ä¸­è¯æ°‘æ—çš„å­˜äº¡ã€‚"
            };
            
            document.getElementById('decisionDescription').textContent = descriptions[gameState.selectedRole];
        }

        function submitDecision() {
            const decision = gameState.currentDecision;
            const input = document.getElementById('decisionInput').value.trim();
            
            if (!decision) {
                alert('è«‹é¸æ“‡ä¸€å€‹è¡Œå‹•æ–¹é‡ï¼');
                return;
            }
            
            // Reasoning is optional - provide default if empty
            if (!input) {
                const defaultReasons = {
                    diplomatic: 'æ¨å‹•å’Œå¹³è«‡åˆ¤',
                    restraint: 'é¿å…è»äº‹å‡ç´š',
                    mediation: 'å°‹æ±‚åœ‹éš›æ”¯æŒ',
                    unity: 'åœ˜çµå…§éƒ¨åŠ›é‡',
                    concession: 'ä»¥é€€ç‚ºé€²',
                    appeal: 'çˆ­å–åœ‹éš›è¼¿è«–'
                };
                input = defaultReasons[decision] || 'ç¶­è­·å’Œå¹³';
            }

            // Hide decision panel and show loading
            document.getElementById('decisionPanel').style.display = 'none';
            document.getElementById('loadingMessage').textContent = 'è™•ç†æ‚¨çš„æ±ºç­–ä¸¦åˆ†æå„æ–¹åæ‡‰...';
            showLoading(true, false);

            // Process decision (simulate AI response)
            setTimeout(() => {
                processDecision(decision, input);
                showLoading(false);

                // Check if simulation should continue
                if (gameState.currentTurn < gameState.maxTurns && !checkEndConditions()) {
                    setTimeout(() => {
                        startNewTurn();
                    }, 2000);
                } else {
                    endSimulation();
                }
            }, 4000);
        }

        function processDecision(decision, reasoning) {
            // More balanced impact values that don't lead to instant victory
            const impacts = {
                diplomatic: { peace: 8, diplomacy: 12, reputation: 5, stability: 3 },
                restraint: { peace: 10, diplomacy: 5, reputation: 8, stability: 5 },
                mediation: { peace: 5, diplomacy: 15, reputation: 10, stability: 2 },
                unity: { peace: 3, diplomacy: 8, reputation: 3, stability: 15 },
                concession: { peace: 12, diplomacy: 8, reputation: -5, stability: -8 },
                appeal: { peace: 5, diplomacy: 10, reputation: 8, stability: 0 }
            };

            // Military pressure reduces peace over time if not actively countered
            gameState.metrics.peace = Math.max(0, gameState.metrics.peace - 2); // Natural decay from military pressure

            const impact = impacts[decision] || { peace: 0, diplomacy: 0, reputation: 0, stability: 0 };
            
            // Apply random variation
            Object.keys(impact).forEach(key => {
                impact[key] += Math.random() * 10 - 5; // Â±5 random variation
            });

            // Update metrics
            gameState.metrics.peace = Math.max(0, Math.min(100, gameState.metrics.peace + impact.peace));
            gameState.metrics.diplomacy = Math.max(0, gameState.metrics.diplomacy + impact.diplomacy);
            gameState.metrics.reputation = Math.max(0, Math.min(100, gameState.metrics.reputation + impact.reputation));
            gameState.metrics.stability = Math.max(0, Math.min(100, gameState.metrics.stability + impact.stability));

            // Update war intention based on BDM model simulation
            updateWarIntention(decision);

            // Update Emperor influence if applicable
            if (gameState.selectedRole === 'emperor') {
                updateEmperorInfluence(decision);
            }

            // Update UI
            updateMetrics();

            // Add decision to events
            const decisionNames = {
                diplomatic: 'å¤–äº¤å€¡è­°',
                restraint: 'è»äº‹å…‹åˆ¶', 
                mediation: 'åœ‹éš›èª¿è§£',
                unity: 'å…§éƒ¨åœ˜çµ',
                concession: 'ç­–ç•¥è®“æ­¥',
                appeal: 'å…¬é–‹å‘¼ç±²'
            };

            addEvent(`${decisionNames[decision]}`, `æ±ºç­–åŸ·è¡Œ: ${reasoning.substring(0, 100)}...`);

            // Generate AI responses
            generateAIResponses(decision);

            // Clear decision input
            gameState.currentDecision = null;
            document.getElementById('decisionInput').value = '';
            document.querySelectorAll('.decision-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }

        function generateAIResponses(playerDecision) {
            const responses = {
                emperor: {
                    diplomatic: "ä¸­åœ‹æ–¹é¢å°å¤©çš‡çš„å’Œå¹³å€¡è­°è¡¨ç¤ºè¬¹æ…æ­“è¿ï¼Œä½†è¦æ±‚å…·é«”ä¿è­‰ã€‚è»éƒ¨å°æ­¤æ±ºå®šè¡¨é”ä¸æ»¿ã€‚",
                    restraint: "è»éƒ¨å‹‰å¼·æ¥å—å¤©çš‡çš„å…‹åˆ¶ä»¤ï¼Œä½†è­¦å‘ŠéŒ¯å¤±æˆ°ç•¥æ©Ÿæœƒã€‚ä¸­åœ‹æ–¹é¢é‡‹å‡ºç©æ¥µä¿¡è™Ÿã€‚",
                    mediation: "åœ‹éš›ç¤¾æœƒè®šæšå¤©çš‡çš„æ™ºæ…§æ±ºå®šï¼Œç¾è‹±è¡¨ç¤ºé¡˜æ„å”åŠ©èª¿åœã€‚"
                },
                chiang: {
                    diplomatic: "æ—¥æœ¬è»éƒ¨å°è«‡åˆ¤æè­°åæ‡‰å†·æ·¡ï¼Œä½†å¤©çš‡åŠæº«å’Œæ´¾è¡¨ç¤ºå¯ä»¥è€ƒæ…®ã€‚",
                    restraint: "ä¸­åœ‹è»éšŠçš„å…‹åˆ¶å§¿æ…‹ç²å¾—åœ‹éš›è®šæšï¼Œä½†åœ‹å…§æ¿€é€²æ´¾æ‰¹è©•éæ–¼è»Ÿå¼±ã€‚",
                    mediation: "åœ‹éš›èª¿åœç²å¾—æ”¯æŒï¼Œä½†æ—¥æœ¬è»éƒ¨è³ªç–‘ç¬¬ä¸‰æ–¹å¹²é çš„åˆæ³•æ€§ã€‚"
                }
            };

            const roleResponses = responses[gameState.selectedRole] || {};
            const response = roleResponses[playerDecision] || "å„æ–¹å°æ‚¨çš„æ±ºå®šåæ‡‰ä¸ä¸€ï¼Œå±€å‹¢ç™¼å±•ä»å¾…è§€å¯Ÿã€‚";
            
            addEvent("å„æ–¹å›æ‡‰", response);
        }

        function updateMetrics() {
            document.getElementById('peaceScore').textContent = Math.round(gameState.metrics.peace);
            document.getElementById('diplomacyScore').textContent = Math.round(gameState.metrics.diplomacy);
            document.getElementById('reputationScore').textContent = Math.round(gameState.metrics.reputation);
            document.getElementById('stabilityScore').textContent = Math.round(gameState.metrics.stability);

            document.getElementById('peaceProgress').style.width = gameState.metrics.peace + '%';
            document.getElementById('diplomacyProgress').style.width = Math.min(100, gameState.metrics.diplomacy) + '%';
            document.getElementById('reputationProgress').style.width = gameState.metrics.reputation + '%';
            document.getElementById('stabilityProgress').style.width = gameState.metrics.stability + '%';

            // Update progress bar colors based on values
            const peaceColor = gameState.metrics.peace > 70 ? '#28a745' : gameState.metrics.peace > 40 ? '#ffc107' : '#dc3545';
            document.getElementById('peaceProgress').style.background = `linear-gradient(45deg, ${peaceColor}, ${peaceColor}dd)`;
        }

        function addEvent(title, description) {
            const eventsList = document.getElementById('eventsList');
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.innerHTML = `
                <div class="event-time">ç¬¬${gameState.currentTurn}å›åˆ - ${title}</div>
                <div>${description}</div>
            `;
            eventsList.appendChild(eventItem);
            eventsList.scrollTop = eventsList.scrollHeight;
        }

        function showLoading(show, isNewTurn = false) {
            const loadingState = document.getElementById('loadingState');
            const loadingProgress = document.getElementById('loadingProgress');
            const currentPlayerThinking = document.getElementById('currentPlayerThinking');

            if (show) {
                loadingState.style.display = 'block';

                // Reset and restart progress animation
                loadingProgress.style.animation = 'none';
                loadingProgress.offsetHeight; // Trigger reflow
                loadingProgress.style.animation = 'progressAnimation 15s ease-in-out';

                // Show who's thinking in default mode
                if (gameState.selectedMode === 'default') {
                    const opponents = {
                        emperor: ['ä¸­åœ‹è»éƒ¨', 'ä¸­å…±å‹¢åŠ›', 'åœ‹éš›è§€å¯Ÿå®¶'],
                        chiang: ['æ—¥æœ¬è»éƒ¨', 'é—œæ±è»', 'æ—¥æœ¬è²¡é–¥']
                    };
                    const currentOpponents = opponents[gameState.selectedRole] || [];
                    const randomOpponent = currentOpponents[Math.floor(Math.random() * currentOpponents.length)];
                    currentPlayerThinking.textContent = isNewTurn ? `${randomOpponent} æ­£åœ¨è©•ä¼°å±€å‹¢...` : '';
                } else {
                    currentPlayerThinking.textContent = '';
                }
            } else {
                loadingState.style.display = 'none';
                currentPlayerThinking.textContent = '';
            }
        }

        function checkEndConditions() {
            // Calculate years passed
            const yearsPassed = Math.floor(gameState.currentTurn / 12);
            const currentYear = gameState.startYear + yearsPassed;

            // Victory: Maintain peace until 1940
            if (currentYear >= 1940) {
                if (gameState.warIntention < 90) {  // Not in total war
                    return 'peace_achieved';
                }
            }

            // Peace failed - war inevitable
            if (gameState.warIntention >= 90) {
                return 'peace_failed';  // Total war threshold
            }

            // Check if reached max turns without war
            if (gameState.currentTurn >= gameState.maxTurns) {
                if (gameState.warIntention < 70) {
                    return 'temporary_peace';
                } else {
                    return 'unstable_peace';
                }
            }

            return false;
        }

        function endSimulation() {
            const endCondition = checkEndConditions();
            let finalMessage = '';
            let resultClass = '';

            if (endCondition === 'peace_achieved') {
                finalMessage = 'ğŸ‰ æ­å–œï¼æ‚¨æˆåŠŸé˜»æ­¢äº†æˆ°çˆ­çš„çˆ†ç™¼ï¼Œå¯¦ç¾äº†å’Œå¹³ï¼æ‚¨çš„å¤–äº¤æ™ºæ…§æ‹¯æ•‘äº†ç„¡æ•¸ç”Ÿå‘½ã€‚';
                resultClass = 'success';
            } else if (endCondition === 'peace_failed') {
                finalMessage = 'ğŸ˜” å¾ˆéºæ†¾ï¼Œå¤–äº¤åŠªåŠ›å¤±æ•—ï¼Œæˆ°çˆ­ä¸å¯é¿å…ã€‚ä½†æ‚¨çš„å˜—è©¦ä»æœ‰æ„ç¾©ï¼Œå’Œå¹³ä¹‹è·¯å¾ä¾†ä¸æ˜“ã€‚';
                resultClass = 'failure';
            } else if (gameState.metrics.peace >= 60) {
                finalMessage = 'ğŸ¤ æ‚¨é”æˆäº†éƒ¨åˆ†å’Œå¹³ç›®æ¨™ã€‚é›–æœªå®Œå…¨é˜»æ­¢è¡çªï¼Œä½†é¡¯è‘—é™ä½äº†æˆ°çˆ­è¦æ¨¡ã€‚';
                resultClass = 'partial';
            } else {
                finalMessage = 'âš–ï¸ å±€å‹¢è¤‡é›œï¼Œçµæœå–œæ†‚åƒåŠã€‚æ­·å²è­‰æ˜ï¼Œå’Œå¹³éœ€è¦å„æ–¹çš„å…±åŒåŠªåŠ›ã€‚';
                resultClass = 'mixed';
            }

            // Display final results
            const resultPanel = document.createElement('div');
            resultPanel.className = `situation-panel ${resultClass}`;
            resultPanel.innerHTML = `
                <div class="situation-title">
                    ğŸ† æ¨¡æ“¬çµæœ
                </div>
                <div style="font-size: 1.2rem; margin-bottom: 20px;">${finalMessage}</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div>æœ€çµ‚å’Œå¹³åˆ†æ•¸: <strong>${Math.round(gameState.metrics.peace)}/100</strong></div>
                    <div>å¤–äº¤æˆåŠŸåº¦: <strong>${Math.round(gameState.metrics.diplomacy)}</strong></div>
                    <div>åœ‹éš›è²æœ›: <strong>${Math.round(gameState.metrics.reputation)}/100</strong></div>
                    <div>å…§éƒ¨ç©©å®š: <strong>${Math.round(gameState.metrics.stability)}/100</strong></div>
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="location.reload()" style="padding: 10px 30px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        ğŸ”„ é‡æ–°é–‹å§‹æ¨¡æ“¬
                    </button>
                    <button onclick="downloadResults()" style="padding: 10px 30px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px;">
                        ğŸ’¾ ä¸‹è¼‰çµæœå ±å‘Š
                    </button>
                </div>
            `;
            
            document.getElementById('situationPanel').replaceWith(resultPanel);
        }

        function updateWarIntention(decision) {
            // Simulate BDM model effects on war intention
            const warEffects = {
                emperor: {
                    do_nothing: 3,  // Military acts more freely
                    diplomatic: -5,
                    restraint: -3,
                    support_military: 8,
                    dismiss_minister: -4,
                    rally_moderates: -6
                },
                chiang: {
                    diplomatic: -8,
                    military_preparation: 10,
                    unite_communists: 5,
                    international_appeal: -3,
                    local_concession: -10,
                    mobilize_nationalism: 15
                }
            };

            const effects = warEffects[gameState.selectedRole] || {};
            const change = effects[decision] || 0;

            // Add random variation to simulate faction dynamics
            const variation = (Math.random() - 0.5) * 5;

            gameState.warIntention = Math.max(0, Math.min(100,
                gameState.warIntention + change + variation));

            // Update war intention display
            document.getElementById('warIntentionScore').textContent = Math.round(gameState.warIntention);
            document.getElementById('warIntentionProgress').style.width = gameState.warIntention + '%';

            // Change color based on danger level
            const progressBar = document.getElementById('warIntentionProgress');
            if (gameState.warIntention >= 90) {
                progressBar.style.background = 'linear-gradient(45deg, #dc3545, #721c24)';
            } else if (gameState.warIntention >= 70) {
                progressBar.style.background = 'linear-gradient(45deg, #ffc107, #dc3545)';
            } else if (gameState.warIntention >= 50) {
                progressBar.style.background = 'linear-gradient(45deg, #28a745, #ffc107)';
            } else {
                progressBar.style.background = 'linear-gradient(45deg, #20c997, #28a745)';
            }
        }

        function updateEmperorInfluence(decision) {
            const influenceCosts = {
                do_nothing: 0,
                diplomatic: -3,
                restraint: -2,
                support_military: 2,  // Gains influence by supporting military
                dismiss_minister: -5,
                rally_moderates: -1
            };

            const cost = influenceCosts[decision] || 0;
            gameState.emperorInfluence = Math.max(5, Math.min(50,
                gameState.emperorInfluence + cost));

            // Positive outcomes can restore some influence
            if (gameState.metrics.peace > 70 && Math.random() > 0.7) {
                gameState.emperorInfluence = Math.min(50, gameState.emperorInfluence + 1);
            }
        }

        function showDecisionPanel() {
            document.getElementById('decisionPanel').style.display = 'block';

            // Update decision description based on role
            const descriptions = {
                emperor: `èº«ç‚ºå¤©çš‡ï¼Œæ‚¨æ“æœ‰é“å¾·æ¬Šå¨ä½†ä¸æ‡‰ç›´æ¥å¹²é æ”¿åºœã€‚ç•¶å‰å½±éŸ¿åŠ›ï¼š${gameState.emperorInfluence.toFixed(0)}/50ã€‚æ¯æ¬¡å¹²é æœƒæ¶ˆè€—å½±éŸ¿åŠ›ã€‚`,
                chiang: `ä½œç‚ºä¸­è¯æ°‘åœ‹é ˜è¢–ï¼Œæ‚¨å¿…é ˆå¹³è¡¡å¤šæ–¹å‹¢åŠ›ã€‚ç•¶å‰æˆ°çˆ­å‚¾å‘ï¼š${gameState.warIntention.toFixed(0)}/100ã€‚`
            };

            document.getElementById('decisionDescription').textContent = descriptions[gameState.selectedRole];

            // Generate decision options based on role
            generateDecisionOptions();
        }

        function generateDecisionOptions() {
            const optionsContainer = document.getElementById('decisionOptions');
            optionsContainer.innerHTML = '';

            let options = [];
            if (gameState.selectedRole === 'emperor') {
                options = [
                    { id: 'do_nothing', icon: 'ğŸ¤', title: 'ä¿æŒæ²‰é»˜', desc: 'ä¸å¹²é æ”¿åºœäº‹å‹™ï¼ˆä¸æ¶ˆè€—å½±éŸ¿åŠ›ï¼‰', cost: 0 },
                    { id: 'diplomatic', icon: 'ğŸ•Šï¸', title: 'å’Œå¹³è²æ˜', desc: 'å…¬é–‹å‘¼ç±²å¤–äº¤è§£æ±º', cost: 3 },
                    { id: 'restraint', icon: 'âœ‹', title: 'ç§ä¸‹å‹¸å‘Š', desc: 'ç§ä¸‹è¦æ±‚è»éƒ¨å…‹åˆ¶', cost: 2 },
                    { id: 'support_military', icon: 'âš”ï¸', title: 'æ”¯æŒè»éƒ¨', desc: 'æ”¯æŒã€Œé˜²ç¦¦æ€§ã€è¡Œå‹•', cost: -2 },
                    { id: 'dismiss_minister', icon: 'ğŸš«', title: 'æ’¤æ›å¤§è‡£', desc: 'è¡Œä½¿æ¬ŠåŠ›æ’¤æ›æ¿€é€²å¤§è‡£', cost: 5 },
                    { id: 'rally_moderates', icon: 'ğŸ¤', title: 'å¬é›†æº«å’Œæ´¾', desc: 'çµ„ç¹”æº«å’Œæ´¾å•†è¨å’Œå¹³', cost: 1 }
                ];
            } else {
                options = [
                    { id: 'diplomatic', icon: 'ğŸ•Šï¸', title: 'ç›´æ¥è«‡åˆ¤', desc: 'æè­°ä¸­æ—¥ç›´æ¥è«‡åˆ¤' },
                    { id: 'military_preparation', icon: 'ğŸ›¡ï¸', title: 'è»äº‹æº–å‚™', desc: 'åŠ å¼·è»äº‹æº–å‚™ï¼Œå±•ç¤ºæ±ºå¿ƒ' },
                    { id: 'unite_communists', icon: 'ğŸ¤', title: 'è¯åˆå…±ç”¢é»¨', desc: 'èˆ‡å…±ç”¢é»¨åˆä½œæŠ—æ—¥' },
                    { id: 'international_appeal', icon: 'ğŸŒ', title: 'åœ‹éš›æ±‚æ´', desc: 'å‘åœ‹éš›ç¤¾æœƒæ±‚åŠ©' },
                    { id: 'local_concession', icon: 'âš–ï¸', title: 'å±€éƒ¨è®“æ­¥', desc: 'å±€éƒ¨è®“æ­¥é¿å…å…¨é¢æˆ°çˆ­' },
                    { id: 'mobilize_nationalism', icon: 'ğŸ“¢', title: 'å‹•å“¡æ°‘æ—ä¸»ç¾©', desc: 'æ¿€ç™¼æ°‘æ—ä¸»ç¾©æƒ…ç·’' }
                ];
            }

            options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'decision-option';
                optionDiv.dataset.option = option.id;

                let costDisplay = '';
                if (gameState.selectedRole === 'emperor' && option.cost !== undefined) {
                    const influenceColor = option.cost > 0 ? '#dc3545' : option.cost < 0 ? '#28a745' : '#6c757d';
                    costDisplay = `<div style="font-size: 0.8rem; color: ${influenceColor}; margin-top: 5px;">å½±éŸ¿åŠ›ï¼š${option.cost > 0 ? '-' : '+'}${Math.abs(option.cost)}</div>`;
                }

                optionDiv.innerHTML = `
                    <strong>${option.icon} ${option.title}</strong>
                    <p>${option.desc}</p>
                    ${costDisplay}
                `;

                // Disable if Emperor doesn't have enough influence
                if (gameState.selectedRole === 'emperor' && option.cost > 0 && gameState.emperorInfluence < option.cost) {
                    optionDiv.style.opacity = '0.5';
                    optionDiv.style.cursor = 'not-allowed';
                    optionDiv.title = 'å½±éŸ¿åŠ›ä¸è¶³';
                } else {
                    optionDiv.addEventListener('click', function() {
                        selectDecisionOption(this.dataset.option);
                    });
                }

                optionsContainer.appendChild(optionDiv);
            });
        }

        function downloadResults() {
            const results = {
                role: gameState.selectedRole,
                mode: gameState.selectedMode,
                turns: gameState.currentTurn,
                finalMetrics: gameState.metrics,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(results, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `peace_simulation_results_${Date.now()}.json`;
            link.click();
        }
    </script>
</body>
</html>
