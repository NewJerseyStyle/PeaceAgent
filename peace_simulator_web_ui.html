<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïäÔ∏è Interactive Peace Simulator - 1937 ‰∏≠Êó•Âç±Ê©ü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .setup-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .role-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .role-card {
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .role-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .role-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .role-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .role-description {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .setting-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .setting-group h3 {
            margin-bottom: 15px;
            color: #333;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .mode-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .mode-option {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .mode-option.active {
            background: #667eea;
            color: white;
        }

        .start-button {
            width: 100%;
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .start-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .simulation-area {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .player-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: bold;
        }

        .metrics-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #28a745;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .situation-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .situation-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .decision-panel {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .decision-title {
            font-weight: bold;
            color: #0c5460;
            margin-bottom: 15px;
        }

        .decision-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .decision-option {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .decision-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .decision-option.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .decision-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 15px;
        }

        .submit-decision {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .submit-decision:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .events-log {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .event-item {
            padding: 10px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
        }

        .event-time {
            font-size: 0.8rem;
            color: #666;
        }

        .dev-panel {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-family: monospace;
        }

        .coalition-panel {
            background: #f8f9fa;
            border: 2px solid #6c757d;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .coalition-panel h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .coalition-panel h4 {
            color: #6c757d;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .war-intention-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .intention-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .intention-label {
            color: #666;
            font-size: 0.95rem;
        }

        .intention-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc3545;
        }

        .coalition-list, .faction-dynamics {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .coalition-item, .faction-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
        }

        .coalition-name, .faction-name {
            font-weight: 600;
            color: #333;
        }

        .coalition-power, .faction-stance {
            color: #666;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes progressAnimation {
            0% { width: 0%; }
            50% { width: 60%; }
            80% { width: 85%; }
            100% { width: 95%; }
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .role-selection {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-panel {
                grid-template-columns: 1fr 1fr;
            }
            
            .decision-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üïäÔ∏è Interactive Peace Simulator</h1>
            <div class="subtitle">1937Âπ¥‰∏≠Êó•Âç±Ê©ü - ‰Ω†ËÉΩÈòªÊ≠¢Êà∞Áà≠ÂóéÔºü</div>
            <p>È´îÈ©óÊ≠∑Âè≤ËΩâÊäòÈªûÔºåÈÅãÁî®Â§ñ‰∫§Êô∫ÊÖßÂåñËß£Âç±Ê©üÔºåÈÅøÂÖçÂÖ®Èù¢Êà∞Áà≠ÁöÑÁàÜÁôº</p>
        </div>

        <!-- Setup Panel -->
        <div class="setup-panel" id="setupPanel">
            <h2 style="margin-bottom: 30px; text-align: center;">üé≠ ÈÅ∏ÊìáÊÇ®ÁöÑËßíËâ≤ËàáË®≠ÂÆö</h2>
            
            <!-- Role Selection -->
            <div class="role-selection">
                <div class="role-card" data-role="emperor">
                    <div class="role-icon">üëë</div>
                    <div class="role-title">Êò≠ÂíåÂ§©Áöá</div>
                    <div class="role-description">
                        Á•ûËÅñ‰∏çÂèØ‰æµÁäØÁöÑÊó•Êú¨Â§©ÁöáÔºåÊìÅÊúâËá≥È´òÁÑ°‰∏äÁöÑÈÅìÂæ∑Â®ÅÊúõ„ÄÇ
                        ÊÇ®ÈúÄË¶ÅÂú®ËªçÈÉ®Â£ìÂäõËàáÂíåÂπ≥ÁêÜÊÉ≥ÈñìÂèñÂæóÂπ≥Ë°°ÔºåÈÅãÁî®Â∏ùÁéãÊ¨äÂ®ÅÈòªÊ≠¢Êà∞Áà≠„ÄÇ
                    </div>
                </div>
                <div class="role-card" data-role="chiang">
                    <div class="role-icon">üáπüáº</div>
                    <div class="role-title">Ëî£‰∏≠Ê≠£</div>
                    <div class="role-description">
                        ‰∏≠ËèØÊ∞ëÂúãÈ†òË¢ñÔºåÈù¢Ëá®Êó•Êú¨‰æµÁï•Â®ÅËÑÖ„ÄÇ
                        ÊÇ®ÂøÖÈ†àÂú®Á∂≠Ë≠∑ÂúãÂÆ∂‰∏ªÊ¨äËàáÈÅøÂÖçÂÖ®Èù¢Êà∞Áà≠ÈñìÂÅöÂá∫Ëâ±Èõ£ÊäâÊìáÔºå‰øùË≠∑‰∏≠Âúã‰∫∫Ê∞ë„ÄÇ
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="settings-grid">
                <div class="setting-group">
                    <h3>ü§ñ AI Ê®°ÂûãÈÅ∏Êìá</h3>
                    <select id="modelSelect">
                        <option value="gemini/gemini-2.0-flash">Gemini 2 Flash (Êé®Ëñ¶)</option>
                        <option value="groq/meta-llama/llama-4-scout-17b-16e-instruct">Groq Llama 4 Scout </option>
                        <option value="groq/llama-3.1-8b-instant">Groq Llama 3.1 8B (Âø´ÈÄü)</option>
                        <option value="gpt-4">OpenAI GPT-4</option>
                        <option value="claude-3">Anthropic Claude-3</option>
                    </select>
                </div>

                <div class="setting-group">
                    <h3>‚è±Ô∏è ÊúÄÂ§ßÂõûÂêàÊï∏</h3>
                    <input type="number" id="maxTurns" value="120" min="12" max="120">
                </div>
            </div>

            <div class="setting-group">
                <h3>üîç Ê®°Êì¨Ê®°Âºè</h3>
                <div class="mode-toggle">
                    <div class="mode-option active" data-mode="default">
                        <div>üëÅÔ∏è ÈªòË™çÊ®°Âºè</div>
                        <small>ÁúüÂØ¶Ë¶ñËßíÔºåÂè™ÁúãÂà∞ËßíËâ≤ÂèØÁç≤ÂæóÁöÑ‰ø°ÊÅØ</small>
                    </div>
                    <div class="mode-option" data-mode="dev">
                        <div>üîç ÈñãÁôºËÄÖÊ®°Âºè</div>
                        <small>ÂÖ®ÈÄèÊòéÔºåÂèØË¶ãÊâÄÊúâËßíËâ≤ÁöÑÊÉ≥Ê≥ïÂíåË®àÂäÉ</small>
                    </div>
                </div>
            </div>

            <button class="start-button" id="startSimulation" disabled>
                üöÄ ÈñãÂßãÂíåÂπ≥Ê®°Êì¨
            </button>
        </div>

        <!-- Simulation Area -->
        <div class="simulation-area" id="simulationArea">
            <!-- Game Header -->
            <div class="game-header">
                <div class="player-info" id="playerInfo">
                    <div>ËßíËâ≤ÔºöÊú™ÈÅ∏Êìá</div>
                    <div>ÂõûÂêàÔºö0/0</div>
                </div>
                <div class="player-info" id="modeInfo">
                    Ê®°ÂºèÔºöÊú™Ë®≠ÂÆö
                </div>
            </div>

            <!-- Peace Metrics -->
            <div class="metrics-panel" id="metricsPanel">
                <div class="metric-card">
                    <div class="metric-value" id="peaceScore">100</div>
                    <div class="metric-label">ÂíåÂπ≥ÂàÜÊï∏</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="peaceProgress" style="width: 100%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="diplomacyScore">0</div>
                    <div class="metric-label">Â§ñ‰∫§ÊàêÂäü</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="diplomacyProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="reputationScore">50</div>
                    <div class="metric-label">ÂúãÈöõËÅ≤Êúõ</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="reputationProgress" style="width: 50%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="stabilityScore">50</div>
                    <div class="metric-label">ÂÖßÈÉ®Á©©ÂÆö</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="stabilityProgress" style="width: 50%"></div>
                    </div>
                </div>
                <div class="metric-card" style="border-left-color: #dc3545;">
                    <div class="metric-value" id="warIntentionScore">50</div>
                    <div class="metric-label">Êà∞Áà≠ÂÇæÂêë</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="warIntentionProgress" style="width: 50%; background: linear-gradient(45deg, #ffc107, #dc3545);"></div>
                    </div>
                </div>
            </div>

            <!-- Current Situation -->
            <div class="situation-panel" id="situationPanel">
                <div class="situation-title">
                    üö® Áï∂ÂâçÂ±ÄÂã¢
                </div>
                <div id="currentSituation">
                    Ê≠£Âú®Âä†ËºâÊÉÖÊ≥ÅÂàÜÊûê...
                </div>
            </div>

            <!-- Decision Panel -->
            <div class="decision-panel" id="decisionPanel" style="display: none;">
                <div class="decision-title">
                    ü§î ÊÇ®ÁöÑÊ±∫Á≠ñÊôÇÂàª
                </div>
                <div id="decisionDescription">
                    Ë´ãÈÅ∏ÊìáÊÇ®ÁöÑË°åÂãïÊñπÈáù...
                </div>
                
                <div class="decision-options" id="decisionOptions">
                    <!-- Options will be dynamically generated based on role -->
                </div>

                <textarea class="decision-input" id="decisionInput"
                          placeholder="Ë™™ÊòéÊÇ®ÁöÑÊ±∫Á≠ñÁêÜÁî±...&#10;&#10;Ê≥®ÊÑèÔºöÊ≠§ÂÖßÂÆπÂÉÖ‰æõË®òÈåÑÔºå‰∏çÊúÉÂΩ±ÈüøÂÖ∂‰ªñÁé©ÂÆ∂„ÄÇ"></textarea>

                <button class="submit-decision" id="submitDecision">
                    ‚úÖ Á¢∫Ë™çÊ±∫Á≠ñ
                </button>
            </div>

            <!-- Events Log -->
            <div class="events-log" id="eventsLog">
                <h3>üìã ‰∫ã‰ª∂Ë®òÈåÑ</h3>
                <div id="eventsList">
                    <div class="event-item">
                        <div class="event-time" id="initialEventDate">1930Âπ¥1Êúà</div>
                        <div id="initialEventDescription">Á∂ìÊøüÂ§ßËï≠Ê¢ùÂΩ±Èüø‰∫ûÊ¥≤ÔºåÊó•Êú¨ËªçÂúã‰∏ªÁæ©Êä¨È†≠</div>
                    </div>
                </div>
            </div>

            <!-- Dev Panel (only visible in dev mode) -->
            <div class="dev-panel" id="devPanel" style="display: none;">
                <h3>üîç ÈñãÁôºËÄÖÊ®°Âºè - AI ‰ª£ÁêÜÊÄùÁ∂≠ÈÅéÁ®ã</h3>
                <div id="devOutput">
                    Á≠âÂæÖ AI ‰ª£ÁêÜÂàÜÊûê...
                </div>
            </div>

            <!-- Coalition Panel (visible in both modes for Chinese leader) -->
            <div class="coalition-panel" id="coalitionPanel" style="display: none;">
                <h3>ü§ù Ê¥æÁ≥ªËàáËÅØÁõüÁãÄÊÖã</h3>
                <div class="coalition-content">
                    <div class="war-intention-display">
                        <div class="intention-card">
                            <span class="intention-label">Êó•Êú¨Êà∞Áà≠ÂÇæÂêëÔºö</span>
                            <span class="intention-value" id="japanWarIntention">--</span>/100
                        </div>
                        <div class="intention-card">
                            <span class="intention-label">‰∏≠ÂúãÊà∞ÂÇôÁãÄÊÖãÔºö</span>
                            <span class="intention-value" id="chinaWarReadiness">--</span>/100
                        </div>
                    </div>

                    <div class="coalition-list" id="coalitionList">
                        <h4>Áï∂ÂâçËÅØÁõüÔºö</h4>
                        <!-- Coalition info will be populated here -->
                    </div>

                    <div class="faction-dynamics" id="factionDynamics">
                        <h4>Ê¥æÁ≥ªÂãïÊÖãÔºö</h4>
                        <!-- Faction dynamics will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loadingState" style="display: none;">
                <div class="spinner"></div>
                <div id="loadingMessage">AI Ê≠£Âú®ÂàÜÊûêÂ±ÄÂã¢‰∏¶Âà∂ÂÆöÂõûÊáâ...</div>
                <div id="currentPlayerThinking" style="font-size: 1.1rem; color: #667eea; margin-top: 10px; font-weight: bold;"></div>
                <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                    ÈÄôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊôÇÈñìÔºåË´ãËÄêÂøÉÁ≠âÂæÖ
                </div>
                <div class="progress-bar" style="width: 80%; margin: 20px auto 0;">
                    <div class="progress-fill" id="loadingProgress" style="width: 0%; animation: progressAnimation 15s ease-in-out;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let gameState = {
            selectedRole: null,
            selectedMode: 'default',
            selectedModel: 'groq/llama3-70b-8192',
            maxTurns: 120,  // 10 years * 12 months (1930-1940)
            startYear: 1930,
            currentTurn: 0,
            isSimulationRunning: false,
            currentDecision: null,
            lastDecision: null,  // Track last decision for war intention calculation
            gameEnded: false,
            outcome: null,
            historicalEvents: [],
            warIntention: 50,  // 0=peace, 100=total war (BDM calculated)
            japanWarIntention: null,  // Will be initialized based on year
            chinaWarReadiness: null,  // Will be initialized based on year
            emperorInfluence: 30,  // Emperor's influence level
            factionStates: {},  // Detailed faction positions
            factionHistory: []  // Track faction changes over time
            metrics: {
                peace: 80,
                diplomacy: 0,
                reputation: 30,
                stability: 20
            }
        };

        // Get AI faction decisions based on game state
        function getAIFactionDecisions(year, month) {
            const decisions = {};

            // Military faction decision based on tensions
            if (gameState.tensions.military_faction > 60) {
                decisions.military = 'escalate';
            } else if (gameState.tensions.military_faction > 40) {
                decisions.military = Math.random() > 0.5 ? 'escalate' : 'maintain';
            } else if (gameState.tensions.military_faction > 25) {
                decisions.military = 'maintain';
            } else {
                decisions.military = 'restrain';
            }

            // Economic faction decision
            if (gameState.tensions.economic_pressure > 70) {
                decisions.economic = 'seek_resources';
            } else if (gameState.tensions.economic_pressure > 50) {
                decisions.economic = 'pressure';
            } else {
                decisions.economic = 'stabilize';
            }

            // Check for historical opportunities
            if (year === 1931 && month >= 9 && gameState.tensions.military_faction > 50) {
                decisions.kwantung = 'manchuria_opportunity';
            }

            if (year === 1936 && month === 2) {
                decisions.military_coup = 'february_26_incident';
            }

            return decisions;
        }

        // Calculate dynamic tensions based on AI decisions and context
        function calculateDynamicTensions(aiDecisions, year) {
            const changes = {
                military_faction: 0,
                economic_pressure: 0,
                nationalist_sentiment: 0,
                international_pressure: 0
            };

            // Military faction actions affect tensions
            if (aiDecisions.military === 'escalate') {
                changes.military_faction += Math.random() * 15 - 5;  // +5 to +10 average
                changes.nationalist_sentiment += Math.random() * 8 - 2;
            } else if (aiDecisions.military === 'restrain') {
                changes.military_faction -= Math.random() * 10;  // -10 to 0
                changes.international_pressure -= Math.random() * 5;
            } else {
                changes.military_faction += Math.random() * 4 - 2;  // -2 to +2
            }

            // Economic pressures can improve or worsen
            if (aiDecisions.economic === 'seek_resources') {
                changes.military_faction += 5;
                changes.economic_pressure += Math.random() * 5;
            } else if (aiDecisions.economic === 'stabilize') {
                changes.economic_pressure -= Math.random() * 8;
            }

            // Historical events create spikes
            if (aiDecisions.kwantung === 'manchuria_opportunity') {
                changes.military_faction += 20;
                changes.nationalist_sentiment += 15;
                changes.international_pressure += 10;
            }

            if (aiDecisions.military_coup === 'february_26_incident') {
                changes.military_faction += 15;
                changes.nationalist_sentiment += 10;
            }

            // Random events for ups and downs (10% chance)
            if (Math.random() < 0.1) {
                const eventType = Math.random();
                if (eventType < 0.3) {
                    // Peace breakthrough
                    changes.military_faction -= 15;
                    changes.nationalist_sentiment -= 10;
                    addEvent("ÂíåÂπ≥Â•ëÊ©ü", "Â§ñ‰∫§Ê∏†ÈÅìÂèñÂæóÁ™ÅÁ†¥ÔºåÁ∑äÂºµÂ±ÄÂã¢Á∑©Ëß£");
                } else if (eventType < 0.6) {
                    // Military incident
                    changes.military_faction += 12;
                    changes.nationalist_sentiment += 8;
                    addEvent("ÈÇäÂ¢ÉË°ùÁ™Å", "Â∞èË¶èÊ®°Ëªç‰∫ãË°ùÁ™ÅÂçáÈ´òÁ∑äÂºµ");
                } else {
                    // Economic crisis
                    changes.economic_pressure += 15;
                    changes.military_faction += 5;
                    addEvent("Á∂ìÊøüÂç±Ê©ü", "Á∂ìÊøüÂõ∞Â¢ÉÂä†ÂäáÔºåËªçÊñπÂ∞ãÊ±ÇÂá∫Ë∑Ø");
                }
            }

            // Depression era effects (1930-1933)
            if (year <= 1933) {
                changes.economic_pressure += Math.random() * 3;
            } else {
                // Recovery period
                changes.economic_pressure -= Math.random() * 2;
            }

            return changes;
        }

        // Check for historical trigger conditions
        function checkHistoricalTriggers(year, month) {
            const triggers = [];

            // Manchurian Incident conditions
            if (year === 1931 && month >= 9) {
                if (gameState.tensions.military_faction > 50 && gameState.tensions.economic_pressure > 40) {
                    triggers.push({
                        name: "‰πù‰∏ÄÂÖ´‰∫ãËÆäÈ¢®Èö™",
                        probability: 0.4,
                        effect: () => {
                            gameState.tensions.military_faction += 25;
                            gameState.japanWarIntention += 20;
                        }
                    });
                }
            }

            // Shanghai Incident
            if (year === 1932 && month === 1) {
                if (gameState.japanWarIntention > 50) {
                    triggers.push({
                        name: "‰∏Ä‰∫åÂÖ´‰∫ãËÆäÂèØËÉΩ",
                        probability: 0.3,
                        effect: () => {
                            gameState.chinaWarReadiness += 15;
                            gameState.tensions.nationalist_sentiment += 10;
                        }
                    });
                }
            }

            // Process triggers
            triggers.forEach(trigger => {
                if (Math.random() < trigger.probability) {
                    trigger.effect();
                    addEvent(trigger.name, "Ê≠∑Âè≤ÈóúÈçµÊôÇÂàªËß∏Áôº");
                }
            });
        }

        // Record faction state for history tracking
        function recordFactionState() {
            const currentYear = gameState.startYear + Math.floor(gameState.currentTurn / 12);
            const currentMonth = (gameState.currentTurn % 12) + 1;

            gameState.factionHistory.push({
                turn: gameState.currentTurn,
                date: `${currentYear}Âπ¥${currentMonth}Êúà`,
                japanWarIntention: gameState.japanWarIntention || 0,
                chinaWarReadiness: gameState.chinaWarReadiness || 0,
                emperorInfluence: gameState.emperorInfluence,
                decision: gameState.lastDecision,
                metrics: {...gameState.metrics}
            });
        }

        // Show detailed game report with visualization
        function showGameReport() {
            const report = generateGameReport();

            // Create modal for report
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 90%; max-height: 90%; overflow-y: auto;">
                    <h2>üéÆ ÈÅäÊà≤Â†±Âëä</h2>
                    ${report}
                    <button onclick="this.closest('div').parentElement.remove()" class="submit-decision" style="margin-top: 20px;">
                        ÈóúÈñâ
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Generate game report with charts
        function generateGameReport() {
            let report = '<div style="font-family: monospace;">';

            // Summary
            report += `<h3>üìä ÈÅäÊà≤Á∏ΩÁµê</h3>`;
            report += `<p>ËßíËâ≤: ${gameState.selectedRole === 'emperor' ? 'Êò≠ÂíåÂ§©Áöá' : 'Ëî£‰∏≠Ê≠£'}</p>`;
            report += `<p>Á∏ΩÂõûÂêàÊï∏: ${gameState.currentTurn}</p>`;
            report += `<p>ÁµêÊûú: ${gameState.outcome === 'war' ? 'Êà∞Áà≠ÁàÜÁôº' : 'ÂíåÂπ≥Á∂≠ÊåÅ'}</p>`;
            report += `<p>ÊúÄÁµÇÊó•Êú¨Êà∞Áà≠ÂÇæÂêë: ${gameState.japanWarIntention}%</p>`;
            report += `<p>ÊúÄÁµÇ‰∏≠ÂúãÊà∞ÂÇô: ${gameState.chinaWarReadiness}%</p>`;

            // War Intention Chart (ASCII)
            report += `<h3>üìà Êà∞Áà≠ÂÇæÂêëËÆäÂåñ</h3>`;
            report += '<pre style="background: #f0f0f0; padding: 10px; border-radius: 5px;">';

            const maxVal = 100;
            const chartHeight = 10;

            // Create simple ASCII chart
            for (let i = chartHeight; i >= 0; i--) {
                const threshold = (i / chartHeight) * maxVal;
                let line = String(Math.round(threshold)).padStart(3, ' ') + '% |';

                gameState.factionHistory.forEach((state, idx) => {
                    if (state.japanWarIntention >= threshold) {
                        line += '‚ñà';
                    } else {
                        line += ' ';
                    }
                });

                if (i === chartHeight) line += ' Êó•Êú¨';
                report += line + '\n';
            }

            report += '     ‚îî' + '‚îÄ'.repeat(gameState.factionHistory.length) + '\n';
            report += '      ';
            gameState.factionHistory.forEach((state, idx) => {
                if (idx % 5 === 0) report += String(idx + 1);
                else report += ' ';
            });
            report += ' (ÂõûÂêà)\n';
            report += '</pre>';

            // Key Decisions
            report += `<h3>üéØ ÈóúÈçµÊ±∫Á≠ñ</h3>`;
            report += '<ul>';
            const keyDecisions = gameState.factionHistory.filter(s => s.decision);
            keyDecisions.forEach(state => {
                const prevState = gameState.factionHistory[state.turn - 1];
                const effect = prevState ? state.japanWarIntention - prevState.japanWarIntention : 0;
                const effectStr = effect > 0 ? `+${effect}%` : `${effect}%`;
                report += `<li>${state.date}: ${state.decision} (Êà∞Áà≠ÂÇæÂêë ${effectStr})</li>`;
            });
            report += '</ul>';

            // Faction drivers
            report += `<h3>üë• Êé®ÂãïÊà∞Áà≠ÁöÑÊ¥æÁ≥ª</h3>`;
            if (gameState.selectedRole === 'emperor') {
                report += `<p>‚Ä¢ ÈóúÊù±Ëªç: ‰∏ªË¶ÅÊé®Êâã (ÊØèÂõûÂêà +2-3%)</p>`;
                report += `<p>‚Ä¢ Áµ±Âà∂Ê¥æ: Êº∏ÈÄ≤Êé®Âãï (ÊØèÂõûÂêà +1-2%)</p>`;
                report += `<p>‚Ä¢ ÁöáÈÅìÊ¥æÊÆòÈ§ò: ÊøÄÈÄ≤Ê¥æ (‰∫ã‰ª∂Ëß∏Áôº +5%)</p>`;
            } else {
                report += `<p>‚Ä¢ Â≠∏ÁîüÈÅãÂãï: Ê∞ëÊóè‰∏ªÁæ© (ÊØèÂõûÂêà +1%)</p>`;
                report += `<p>‚Ä¢ ÂÖ±Áî¢Èª®: ÊäóÊó•Áµ±‰∏ÄÊà∞Á∑ö (ËÅØÂêàÊôÇ +3%)</p>`;
                report += `<p>‚Ä¢ Âú∞ÊñπËªçÈñ•: Ëá™‰øùÁÇ∫‰∏ª (ËÆäÂãï)</p>`;
            }

            report += '</div>';
            return report;
        }

        // Export game data as JSON
        function exportGameData() {
            const exportData = {
                gameInfo: {
                    role: gameState.selectedRole,
                    startYear: gameState.startYear,
                    totalTurns: gameState.currentTurn,
                    outcome: gameState.outcome
                },
                factionHistory: gameState.factionHistory,
                events: gameState.historicalEvents,
                finalMetrics: gameState.metrics,
                finalWarIntentions: {
                    japan: gameState.japanWarIntention,
                    china: gameState.chinaWarReadiness
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = `peace_simulator_${gameState.selectedRole}_${Date.now()}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Reset game to start new session
        function resetGame() {
            // Reset all game state
            gameState = {
                selectedRole: null,
                selectedMode: 'default',
                selectedModel: 'groq/llama3-70b-8192',
                maxTurns: 120,
                startYear: 1930,
                currentTurn: 0,
                isSimulationRunning: false,
                currentDecision: null,
                lastDecision: null,
                gameEnded: false,
                outcome: null,
                historicalEvents: [],
                warIntention: 50,
                japanWarIntention: null,
                chinaWarReadiness: null,
                emperorInfluence: 30,
                factionStates: {},
                factionHistory: [],
                metrics: {
                    peace: 80,
                    diplomacy: 0,
                    reputation: 30,
                    stability: 20
                }
            };

            // Reset UI
            document.getElementById('setupScreen').style.display = 'flex';
            document.getElementById('simulationScreen').style.display = 'none';
            document.getElementById('coalitionPanel').style.display = 'none';
            document.getElementById('devPanel').style.display = 'none';
            document.getElementById('decisionPanel').style.display = 'none';

            // Clear events log
            document.getElementById('eventsList').innerHTML = `
                <div class="event-item">
                    <div class="event-time">1930Âπ¥1Êúà</div>
                    <div>Á∂ìÊøüÂ§ßËï≠Ê¢ùÂΩ±Èüø‰∫ûÊ¥≤ÔºåÊó•Êú¨ËªçÂúã‰∏ªÁæ©Êä¨È†≠</div>
                </div>
            `;

            // Reset role selection
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        // Initialize UI
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            checkAPIConfiguration();
        });

        function initializeEventListeners() {
            // Role selection
            document.querySelectorAll('.role-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectRole(this.dataset.role);
                });
            });

            // Mode selection
            document.querySelectorAll('.mode-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectMode(this.dataset.mode);
                });
            });

            // Settings
            document.getElementById('modelSelect').addEventListener('change', function() {
                gameState.selectedModel = this.value;
            });

            document.getElementById('maxTurns').addEventListener('change', function() {
                gameState.maxTurns = parseInt(this.value);
            });

            // Start simulation
            document.getElementById('startSimulation').addEventListener('click', startSimulation);

            // Decision options
            document.querySelectorAll('.decision-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectDecisionOption(this.dataset.option);
                });
            });

            // Submit decision
            document.getElementById('submitDecision').addEventListener('click', submitDecision);
        }

        function selectRole(role) {
            gameState.selectedRole = role;
            
            // Update UI
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.role === role);
            });

            checkStartConditions();
        }

        function selectMode(mode) {
            gameState.selectedMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.toggle('active', option.dataset.mode === mode);
            });
        }

        function selectDecisionOption(option) {
            gameState.currentDecision = option;
            
            // Update UI
            document.querySelectorAll('.decision-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.option === option);
            });
        }

        function checkStartConditions() {
            const canStart = gameState.selectedRole !== null;
            document.getElementById('startSimulation').disabled = !canStart;
        }

        function checkAPIConfiguration() {
            // In a real implementation, this would check if API keys are configured
            // For demo purposes, we'll assume they're available
            console.log('Checking API configuration...');
        }

        function startSimulation() {
            if (!gameState.selectedRole) {
                alert('Ë´ãÂÖàÈÅ∏ÊìáËßíËâ≤ÔºÅ');
                return;
            }

            gameState.isSimulationRunning = true;
            gameState.currentTurn = 0;

            // Set different initial states based on role
            if (gameState.selectedRole === 'emperor') {
                // Japan in 1930: Economic crisis but military ambitions growing
                gameState.metrics = {
                    peace: 65,      // Some militarism but not war yet
                    diplomacy: 20,  // Limited diplomatic success
                    reputation: 60, // Still respected internationally
                    stability: 45   // Economic crisis affecting stability
                };
                gameState.warIntention = 35; // Military planning but not ready
                gameState.emperorInfluence = 40; // Stronger initially
            } else { // Chiang
                // China in 1930: Civil war, Japanese pressure, weak central government
                gameState.metrics = {
                    peace: 45,      // Internal conflicts and Japanese threats
                    diplomacy: 15,  // Limited international support
                    reputation: 35, // Seen as divided and weak
                    stability: 25   // Civil war and warlordism
                };
                gameState.warIntention = 25; // More defensive posture
            }

            // Update initial display
            updateMetrics();

            // Hide setup panel and show simulation
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('simulationArea').style.display = 'block';

            // Update player info
            const roleNames = {
                emperor: 'Êò≠ÂíåÂ§©Áöá',
                chiang: 'Ëî£‰∏≠Ê≠£'
            };
            
            const modeNames = {
                default: 'ÈªòË™çÊ®°Âºè',
                dev: 'ÈñãÁôºËÄÖÊ®°Âºè'
            };

            document.getElementById('playerInfo').innerHTML = `
                <div>ËßíËâ≤Ôºö${roleNames[gameState.selectedRole]}</div>
                <div>ÂõûÂêàÔºö${gameState.currentTurn}/${gameState.maxTurns}</div>
            `;
            document.getElementById('modeInfo').textContent = `Ê®°ÂºèÔºö${modeNames[gameState.selectedMode]}`;

            // Show dev panel if in dev mode
            if (gameState.selectedMode === 'dev') {
                document.getElementById('devPanel').style.display = 'block';
            }

            // Start first turn with a small delay to ensure UI is ready
            setTimeout(() => {
                startNewTurn();
            }, 100);
        }

        function startNewTurn() {
            // Check if game has ended
            if (gameState.gameEnded) {
                return;
            }

            gameState.currentTurn++;

            // Update turn counter
            const roleNames = {
                emperor: 'Êò≠ÂíåÂ§©Áöá',
                chiang: 'Ëî£‰∏≠Ê≠£'
            };

            document.getElementById('playerInfo').innerHTML = `
                <div>ËßíËâ≤Ôºö${roleNames[gameState.selectedRole]}</div>
                <div>ÂõûÂêàÔºö${gameState.currentTurn}/${gameState.maxTurns}</div>
            `;

            // Show loading state with current turn info
            showLoading(true, true);

            // Update coalition status if playing as Chinese leader or in dev mode
            if (gameState.selectedRole === 'chiang' || gameState.selectedMode === 'dev') {
                updateCoalitionStatus();

                // If war was triggered, don't continue
                if (gameState.gameEnded) {
                    return;
                }

                // Record faction state for history tracking
                recordFactionState();
            }

            // Simulate AI analysis (in real implementation, this would call the backend)
            setTimeout(() => {
                if (!gameState.gameEnded) {
                    generateSituationUpdate();
                    showLoading(false);
                    showDecisionPanel();
                }
            }, 3000);
        }

        function generateSituationUpdate() {
            // Calculate current date
            const currentYear = gameState.startYear + Math.floor(gameState.currentTurn / 12);
            const currentMonth = (gameState.currentTurn % 12) + 1;

            // Generate historically accurate situations based on year
            let currentSituation = "";
            if (gameState.selectedRole === 'emperor') {
                if (currentYear === 1930) {
                    const situations1930 = [
                        "ÂÄ´Êï¶Êµ∑ËªçÊúÉË≠∞Ê≠£Âú®ÈÄ≤Ë°åÔºåÊµ∑ËªçÂàÜË£ÇÁÇ∫Ê¢ùÁ¥ÑÊ¥æÂíåËâ¶ÈöäÊ¥æ„ÄÇËªçÈÉ®Ë¶ÅÊ±ÇÊÇ®ÊîØÊåÅÊì¥ÂºµÊµ∑Ëªç„ÄÇ",
                        "Á∂ìÊøüÂ§ßËï≠Ê¢ùÂΩ±ÈüøÊó•Êú¨ÔºåËæ≤ÊùëÁ†¥Áî¢Âö¥Èáç„ÄÇËªçÈÉ®ÊèêÂá∫ÂêëÊªøÊ¥≤Êì¥Âºµ‰ª•Ëß£Ê±∫Á∂ìÊøüÂïèÈ°å„ÄÇ",
                        "‰∏âÊúà‰∫ã‰ª∂ÁöÑË¨†Ë®ÄÂú®Ëªç‰∏≠ÂÇ≥Êí≠ÔºåÊøÄÈÄ≤ËªçÂÆòË®àÂäÉÊîøËÆä„ÄÇÊÇ®ÈúÄË¶ÅÊ±∫ÂÆöÂ¶Ç‰ΩïÊáâÂ∞ç„ÄÇ",
                        "ÈóúÊù±ËªçÂ†±ÂëäÂºµÂ≠∏ËâØÂú®Êù±ÂåóÂ¢ûÂº∑ÊéßÂà∂ÔºåÂª∫Ë≠∞ÂÖàÁôºÂà∂‰∫∫„ÄÇÂ§ñÂãôÁúÅ‰∏ªÂºµË¨πÊÖé„ÄÇ"
                    ];
                    currentSituation = situations1930[currentMonth % situations1930.length];
                } else if (currentYear === 1931) {
                    currentSituation = "‰∏≠ÊùëÂ§ßÂ∞â‰∫ã‰ª∂ÂæåÔºåÈóúÊù±ËªçË¶ÅÊ±ÇÂ†±Âæ©„ÄÇÁü≥ÂéüËéûÁàæÊ≠£Âú®Á≠ñÂäÉÊüê‰∫õË°åÂãï„ÄÇ";
                } else if (currentYear >= 1936) {
                    currentSituation = "‰∫å‰∫åÂÖ≠‰∫ã‰ª∂ÂæåÔºåËªçÈÉ®Áµ±Âà∂Ê¥æÂÆåÂÖ®ÊéåÊ¨ä„ÄÇÂ∞çËèØÊîøÁ≠ñÈúÄË¶ÅÊÇ®ÁöÑÊåáÂºï„ÄÇ";
                } else {
                    currentSituation = "ËªçÈÉ®ÊåÅÁ∫åÊé®ÂãïÊì¥ÂºµÊîøÁ≠ñÔºåÂ§ñÂãôÁúÅÂä™ÂäõÁ∂≠ÊåÅÂíåÂπ≥„ÄÇÊÇ®ÁöÑÊ±∫ÂÆöËá≥ÈóúÈáçË¶Å„ÄÇ";
                }
            } else { // chiang
                if (currentYear === 1930) {
                    const situations1930 = [
                        "‰∏≠ÂéüÂ§ßÊà∞ÂâõÁµêÊùüÔºåÂêÑÂú∞ËªçÈñ•‰ªç‰∏çÊúçÂæû‰∏≠Â§Æ„ÄÇÁ¥ÖËªçÂú®Ê±üË•øÂª∫Á´ãÊ†πÊìöÂú∞„ÄÇ",
                        "Êó•Êú¨Âú®ÊªøÊ¥≤Âä†Âº∑Ê¥ªÂãïÔºå‰ΩÜÁõÆÂâç‰∏ªË¶ÅÂ®ÅËÑÖ‰æÜËá™ÂÖßÈÉ®„ÄÇÂÖ±Áî¢Èª®Âú®Ë¥õÂ∑ûÊì¥Âºµ„ÄÇ",
                        "Âæ∑ÂúãÈ°ßÂïèÂúòÂª∫Ë≠∞ÂÖàÁµ±‰∏ÄÂúãÂÖßÂÜçÂ∞çÂ§ñ„ÄÇË≤°ÊîøÂõ∞Èõ£ÔºåÈúÄË¶ÅÁ∂ìÊøüÂª∫Ë®≠„ÄÇ",
                        "Âª£Êù±Âª£Ë•øËªçÈñ•Ë¶ÅÊ±ÇËá™Ê≤ªÔºåÂåóÊñπËªçÈñ•ËßÄÊúõ„ÄÇÂúãÊ∞ëÈª®ÂÖßÈÉ®ÂàÜË£ÇÂö¥Èáç„ÄÇ"
                    ];
                    currentSituation = situations1930[currentMonth % situations1930.length];
                } else if (currentYear === 1931 && currentMonth >= 9) {
                    currentSituation = "‰πù‰∏ÄÂÖ´‰∫ãËÆäÁôºÁîüÔºåÊù±ÂåóÂç±ÊÄ•„ÄÇ‰ΩÜÊÇ®Ê≠£Âú®Á¨¨‰∏âÊ¨°ÂúçÂâø‰∏≠ÔºåÁÑ°Ê≥ïÂÖ®ÂäõÊáâÂ∞ç„ÄÇ";
                } else if (currentYear >= 1936) {
                    currentSituation = "Ë•øÂÆâ‰∫ãËÆäÂâçÂ§ïÔºåÂºµÂ≠∏ËâØÂíåÊ•äËôéÂüéË¶ÅÊ±ÇÂÅúÊ≠¢ÂÖßÊà∞„ÄÇÂÖ±Áî¢Èª®ÊèêÂá∫Âêà‰ΩúÊäóÊó•„ÄÇ";
                } else {
                    currentSituation = "ÂÖßÊÜÇÂ§ñÊÇ£‰∏¶Â≠òÔºåÈúÄË¶ÅÂú®Áµ±‰∏ÄÂúãÂÖßÂíåÈò≤Á¶¶Â§ñÊïµÈñìÂπ≥Ë°°„ÄÇ";
                }
            }

            // Get historical context
            const historicalContext = getHistoricalContext(currentYear, currentMonth);

            // Check for random incident
            const incident = generateRandomIncident(currentYear, currentMonth, gameState.warIntention);
            if (incident) {
                // Apply incident effects
                gameState.metrics.peace += incident.peaceEffect;
                gameState.warIntention += incident.warEffect;
                gameState.warIntention = Math.max(0, Math.min(100, gameState.warIntention));
                updateMetrics();
            }

            // Generate dynamic news
            const dynamicNews = generateDynamicNews(currentYear, currentMonth, gameState.warIntention);

            // Build situation display
            let situationHtml = `
                <div style="font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; color: #667eea;">${currentYear}Âπ¥${currentMonth}Êúà</div>
                <div style="background: #e8f4f8; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <strong>Ê≠∑Âè≤ËÉåÊôØÔºö</strong> ${historicalContext}
                </div>`;

            if (incident) {
                situationHtml += `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; margin: 15px 0;">
                        <div style="font-weight: bold; color: #dc3545; margin-bottom: 5px;">‚ö†Ô∏è Á™ÅÁôº‰∫ã‰ª∂Ôºö${incident.title}</div>
                        <div style="color: #856404;">${incident.description}</div>
                    </div>`;
            }

            situationHtml += `
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #dee2e6;">
                    <strong>Áï∂ÂâçÂ±ÄÂã¢Ôºö</strong> ${currentSituation}
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-left: 3px solid #6c757d; font-style: italic;">
                    <strong>üì∞ ÊúÄÊñ∞Ê∂àÊÅØÔºö</strong> ${dynamicNews}
                </div>`;

            document.getElementById('currentSituation').innerHTML = situationHtml;

            // Add event to log
            addEvent(`${currentYear}Âπ¥${currentMonth}Êúà`, currentSituation);

            // Enhanced dev mode with year-appropriate AI thoughts
            if (gameState.selectedMode === 'dev') {
                const devOutput = document.getElementById('devOutput');
                devOutput.innerHTML = '<div style="font-weight: bold; margin-bottom: 10px;">ü§ñ AI‰ª£ÁêÜÊÄùÁ∂≠ÈÅéÁ®ãÔºö</div>';

                // Generate year-appropriate thoughts
                const aiThoughts = generateAIThoughts(currentYear, currentMonth, gameState.selectedRole);

                aiThoughts.forEach((item, index) => {
                    setTimeout(() => {
                        const thoughtDiv = document.createElement('div');
                        thoughtDiv.style.cssText = "margin: 10px 0; padding: 12px; background: linear-gradient(135deg, #f5f5f5, #e8e8e8); border-left: 3px solid #667eea; border-radius: 5px; opacity: 0; transition: opacity 0.5s;";
                        thoughtDiv.innerHTML = `
                            <strong style="color: #667eea;">${item.agent}:</strong>
                            <div style="color: #333; font-style: italic; margin-top: 5px;">"${item.thought}"</div>
                        `;
                        devOutput.appendChild(thoughtDiv);
                        setTimeout(() => { thoughtDiv.style.opacity = '1'; }, 50);
                    }, index * 800);
                });

                // Show faction war positions
                setTimeout(() => {
                    const factionDiv = document.createElement('div');
                    factionDiv.style.cssText = "margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;";
                    factionDiv.innerHTML = `
                        <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">üìä ÂêÑÊ¥æÁ≥ªÊà∞Áà≠ÂÇæÂêëÂàÜÊûêÔºö</div>
                        <div>üî¥ ËªçÈÉ®ÊøÄÈÄ≤Ê¥æ: ${Math.min(95, gameState.warIntention + 25)}%</div>
                        <div>üü° ËªçÈÉ®Ê∫´ÂíåÊ¥æ: ${Math.max(20, Math.min(80, gameState.warIntention))}%</div>
                        <div>üü¢ Â§ñÂãôÁúÅ: ${Math.max(10, gameState.warIntention - 35)}%</div>
                        <div>üí∞ Ë≤°Èñ•: ${Math.max(15, gameState.warIntention - 25)}%</div>
                        <div>üëë ÂÆÆÂª∑: ${Math.max(5, gameState.warIntention - 40)}%</div>
                    `;
                    devOutput.appendChild(factionDiv);
                }, aiThoughts.length * 800 + 500);
            }
        }

        function showDecisionPanel() {
            document.getElementById('decisionPanel').style.display = 'block';
            
            // Update decision description based on role
            const descriptions = {
                emperor: "Ë∫´ÁÇ∫Â§©ÁöáÔºåÊÇ®ÊìÅÊúâËá≥È´òÁÑ°‰∏äÁöÑÈÅìÂæ∑Â®ÅÊúõ„ÄÇÊÇ®ÁöÑÊ±∫ÂÆöÂ∞áÂΩ±ÈüøÂ∏ùÂúãÁöÑÊú™‰æÜÊñπÂêë„ÄÇË´ãÊÖéÈáçËÄÉÊÖÆÂ¶Ç‰ΩïÈÅãÁî®ÊÇ®ÁöÑÊ¨äÂ®Å‰æÜÁ∂≠Ë≠∑ÂíåÂπ≥„ÄÇ",
                chiang: "‰ΩúÁÇ∫‰∏≠ËèØÊ∞ëÂúãÁöÑÈ†òË¢ñÔºåÊÇ®ÂøÖÈ†àÂú®Á∂≠Ë≠∑ÂúãÂÆ∂‰∏ªÊ¨äËàáÈÅøÂÖç‰∫∫Ê∞ëÂèóÊà∞Áà≠‰πãËã¶ÈñìÂèñÂæóÂπ≥Ë°°„ÄÇÊÇ®ÁöÑÊ±∫Á≠ñÈóú‰øÇ‰∏≠ËèØÊ∞ëÊóèÁöÑÂ≠ò‰∫°„ÄÇ"
            };
            
            document.getElementById('decisionDescription').textContent = descriptions[gameState.selectedRole];
        }

        function submitDecision() {
            const decision = gameState.currentDecision;
            const input = document.getElementById('decisionInput').value.trim();
            
            if (!decision) {
                alert('Ë´ãÈÅ∏Êìá‰∏ÄÂÄãË°åÂãïÊñπÈáùÔºÅ');
                return;
            }
            
            // Reasoning is optional - provide default if empty
            if (!input) {
                const defaultReasons = {
                    diplomatic: 'Êé®ÂãïÂíåÂπ≥Ë´áÂà§',
                    restraint: 'ÈÅøÂÖçËªç‰∫ãÂçáÁ¥ö',
                    mediation: 'Â∞ãÊ±ÇÂúãÈöõÊîØÊåÅ',
                    unity: 'ÂúòÁµêÂÖßÈÉ®ÂäõÈáè',
                    concession: '‰ª•ÈÄÄÁÇ∫ÈÄ≤',
                    appeal: 'Áà≠ÂèñÂúãÈöõËºøË´ñ'
                };
                input = defaultReasons[decision] || 'Á∂≠Ë≠∑ÂíåÂπ≥';
            }

            // Hide decision panel and show loading
            document.getElementById('decisionPanel').style.display = 'none';
            document.getElementById('loadingMessage').textContent = 'ËôïÁêÜÊÇ®ÁöÑÊ±∫Á≠ñ‰∏¶ÂàÜÊûêÂêÑÊñπÂèçÊáâ...';
            showLoading(true, false);

            // Process decision (simulate AI response)
            setTimeout(() => {
                processDecision(decision, input);
                showLoading(false);

                // Check if simulation should continue
                if (gameState.currentTurn < gameState.maxTurns && !checkEndConditions()) {
                    setTimeout(() => {
                        startNewTurn();
                    }, 2000);
                } else {
                    endSimulation();
                }
            }, 4000);
        }

        function processDecision(decision, reasoning) {
            // More balanced impact values that don't lead to instant victory
            const impacts = {
                diplomatic: { peace: 8, diplomacy: 12, reputation: 5, stability: 3 },
                restraint: { peace: 10, diplomacy: 5, reputation: 8, stability: 5 },
                mediation: { peace: 5, diplomacy: 15, reputation: 10, stability: 2 },
                unity: { peace: 3, diplomacy: 8, reputation: 3, stability: 15 },
                concession: { peace: 12, diplomacy: 8, reputation: -5, stability: -8 },
                appeal: { peace: 5, diplomacy: 10, reputation: 8, stability: 0 }
            };

            // Military pressure reduces peace over time if not actively countered
            gameState.metrics.peace = Math.max(0, gameState.metrics.peace - 2); // Natural decay from military pressure

            const impact = impacts[decision] || { peace: 0, diplomacy: 0, reputation: 0, stability: 0 };
            
            // Apply random variation
            Object.keys(impact).forEach(key => {
                impact[key] += Math.random() * 10 - 5; // ¬±5 random variation
            });

            // Update metrics
            gameState.metrics.peace = Math.max(0, Math.min(100, gameState.metrics.peace + impact.peace));
            gameState.metrics.diplomacy = Math.max(0, gameState.metrics.diplomacy + impact.diplomacy);
            gameState.metrics.reputation = Math.max(0, Math.min(100, gameState.metrics.reputation + impact.reputation));
            gameState.metrics.stability = Math.max(0, Math.min(100, gameState.metrics.stability + impact.stability));

            // Update war intention based on BDM model simulation
            updateWarIntention(decision);

            // Update Emperor influence if applicable
            if (gameState.selectedRole === 'emperor') {
                updateEmperorInfluence(decision);
            }

            // Update UI
            updateMetrics();

            // Add decision to events
            const decisionNames = {
                diplomatic: 'Â§ñ‰∫§ÂÄ°Ë≠∞',
                restraint: 'Ëªç‰∫ãÂÖãÂà∂', 
                mediation: 'ÂúãÈöõË™øËß£',
                unity: 'ÂÖßÈÉ®ÂúòÁµê',
                concession: 'Á≠ñÁï•ËÆìÊ≠•',
                appeal: 'ÂÖ¨ÈñãÂëºÁ±≤'
            };

            // Track the decision for war intention calculation
            gameState.lastDecision = decision;

            addEvent(`${decisionNames[decision]}`, `Ê±∫Á≠ñÂü∑Ë°å: ${reasoning.substring(0, 100)}...`);

            // Generate AI responses
            generateAIResponses(decision);

            // Clear decision input
            gameState.currentDecision = null;
            document.getElementById('decisionInput').value = '';
            document.querySelectorAll('.decision-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }

        function generateAIResponses(playerDecision) {
            const responses = {
                emperor: {
                    diplomatic: "‰∏≠ÂúãÊñπÈù¢Â∞çÂ§©ÁöáÁöÑÂíåÂπ≥ÂÄ°Ë≠∞Ë°®Á§∫Ë¨πÊÖéÊ≠ìËøéÔºå‰ΩÜË¶ÅÊ±ÇÂÖ∑È´î‰øùË≠â„ÄÇËªçÈÉ®Â∞çÊ≠§Ê±∫ÂÆöË°®ÈÅî‰∏çÊªø„ÄÇ",
                    restraint: "ËªçÈÉ®ÂãâÂº∑Êé•ÂèóÂ§©ÁöáÁöÑÂÖãÂà∂‰ª§Ôºå‰ΩÜË≠¶ÂëäÈåØÂ§±Êà∞Áï•Ê©üÊúÉ„ÄÇ‰∏≠ÂúãÊñπÈù¢ÈáãÂá∫Á©çÊ•µ‰ø°Ëôü„ÄÇ",
                    mediation: "ÂúãÈöõÁ§æÊúÉËÆöÊèöÂ§©ÁöáÁöÑÊô∫ÊÖßÊ±∫ÂÆöÔºåÁæéËã±Ë°®Á§∫È°òÊÑèÂçîÂä©Ë™øÂÅú„ÄÇ"
                },
                chiang: {
                    diplomatic: "Êó•Êú¨ËªçÈÉ®Â∞çË´áÂà§ÊèêË≠∞ÂèçÊáâÂÜ∑Ê∑°Ôºå‰ΩÜÂ§©ÁöáÂèäÊ∫´ÂíåÊ¥æË°®Á§∫ÂèØ‰ª•ËÄÉÊÖÆ„ÄÇ",
                    restraint: "‰∏≠ÂúãËªçÈöäÁöÑÂÖãÂà∂ÂßøÊÖãÁç≤ÂæóÂúãÈöõËÆöÊèöÔºå‰ΩÜÂúãÂÖßÊøÄÈÄ≤Ê¥æÊâπË©ïÈÅéÊñºËªüÂº±„ÄÇ",
                    mediation: "ÂúãÈöõË™øÂÅúÁç≤ÂæóÊîØÊåÅÔºå‰ΩÜÊó•Êú¨ËªçÈÉ®Ë≥™ÁñëÁ¨¨‰∏âÊñπÂπ≤È†êÁöÑÂêàÊ≥ïÊÄß„ÄÇ"
                }
            };

            const roleResponses = responses[gameState.selectedRole] || {};
            const response = roleResponses[playerDecision] || "ÂêÑÊñπÂ∞çÊÇ®ÁöÑÊ±∫ÂÆöÂèçÊáâ‰∏ç‰∏ÄÔºåÂ±ÄÂã¢ÁôºÂ±ï‰ªçÂæÖËßÄÂØü„ÄÇ";
            
            addEvent("ÂêÑÊñπÂõûÊáâ", response);
        }

        function updateCoalitionStatus() {
            // Show coalition panel
            document.getElementById('coalitionPanel').style.display = 'block';

            // Simulate coalition data (in real implementation, fetch from backend)
            const coalitionData = generateCoalitionData();

            // Update war intentions
            document.getElementById('japanWarIntention').textContent = coalitionData.japanWarIntention;
            document.getElementById('chinaWarReadiness').textContent = coalitionData.chinaWarReadiness;

            // Check for automatic war trigger
            if (coalitionData.japanWarIntention >= 100 || coalitionData.chinaWarReadiness >= 100) {
                triggerAutomaticWar(coalitionData);
                return;
            }

            // Update coalition list
            const coalitionListHTML = coalitionData.coalitions.map(coalition => `
                <div class="coalition-item">
                    <span class="coalition-name">${coalition.name}</span>
                    <span class="coalition-power">ÊàêÂì°: ${coalition.members} | ÂØ¶Âäõ: ${coalition.power}</span>
                </div>
            `).join('');
            document.getElementById('coalitionList').innerHTML = '<h4>Áï∂ÂâçËÅØÁõüÔºö</h4>' + coalitionListHTML;

            // Update faction dynamics
            const factionHTML = coalitionData.factions.map(faction => `
                <div class="faction-item">
                    <span class="faction-name">${faction.name}</span>
                    <span class="faction-stance">${faction.focus} | ${faction.stance}</span>
                </div>
            `).join('');
            document.getElementById('factionDynamics').innerHTML = '<h4>Ê¥æÁ≥ªÂãïÊÖãÔºö</h4>' + factionHTML;
        }

        function triggerAutomaticWar(coalitionData) {
            // War has been automatically triggered
            showLoading(false);
            document.getElementById('decisionPanel').style.display = 'none';

            let warStarter = '';
            let message = '';

            if (coalitionData.japanWarIntention >= 100) {
                warStarter = 'Êó•Êú¨';
                message = 'Êó•Êú¨ËªçÈÉ®ÂÆåÂÖ®Â§±ÊéßÔºåÁôºÂãïÂÖ®Èù¢‰æµËèØÊà∞Áà≠ÔºÅÂíåÂπ≥Âä™ÂäõÂ§±Êïó„ÄÇ';
            } else {
                warStarter = '‰∏≠Âúã';
                message = '‰∏≠ÂúãÂêÑÊ¥æÁ≥ªÈÅîÊàêÂÖ±Ë≠òÔºåÊ±∫ÂÆöÂÖ®Èù¢ÊäóÊà∞ÔºÅÂ§ñ‰∫§ÈÄîÂæëÂ∑≤Á∂ìÈóúÈñâ„ÄÇ';
            }

            // Display war outcome
            document.getElementById('currentSituation').innerHTML = `
                <div style="color: #dc3545; font-size: 1.5rem; font-weight: bold;">
                    üí• Êà∞Áà≠ÁàÜÁôºÔºÅ${warStarter}Êà∞Áà≠ÂÇæÂêëÈÅîÂà∞100%
                </div>
                <p style="margin-top: 20px;">${message}</p>
                <p style="margin-top: 20px; font-weight: bold;">
                    ÈÅäÊà≤ÁµêÊùü - ÂíåÂπ≥Â§±Êïó
                </p>
                <div style="margin-top: 30px;">
                    <button onclick="showGameReport()" class="submit-decision" style="background: #17a2b8; margin-right: 10px;">
                        üìä Êü•ÁúãË©≥Á¥∞Â†±Âëä
                    </button>
                    <button onclick="exportGameData()" class="submit-decision" style="background: #28a745; margin-right: 10px;">
                        üíæ Â∞éÂá∫ÈÅäÊà≤Êï∏Êìö
                    </button>
                    <button onclick="resetGame()" class="submit-decision" style="background: #667eea;">
                        üîÑ ÈáçÊñ∞ÈñãÂßã
                    </button>
                </div>
            `;

            // Add to events log
            addEvent("Êà∞Áà≠ÁàÜÁôº", `${warStarter}ÁôºÂãïÂÖ®Èù¢Êà∞Áà≠ÔºåÂíåÂπ≥Âä™ÂäõÂ§±Êïó`);

            // End game
            gameState.gameEnded = true;
            gameState.outcome = 'war';

            // Record faction state at time of war
            recordFactionState();
        }

        function generateCoalitionData() {
            // Simulate dynamic coalition data based on turn
            const turn = gameState.currentTurn;
            const currentYear = gameState.startYear + Math.floor(turn / 12);
            const currentMonth = (turn % 12) + 1;

            // Initialize faction war intentions if not set
            if (!gameState.japanWarIntention) {
                gameState.japanWarIntention = 35;  // 1930 starting point
                gameState.chinaWarReadiness = 25;  // 1930 starting point
                gameState.tensions = {
                    military_faction: 35,
                    economic_pressure: 45,
                    nationalist_sentiment: 30,
                    international_pressure: 20
                };
            }

            // DYNAMIC SYSTEM - NO FIXED ESCALATION RATE!
            // Use AI decisions, coalition dynamics, and game theory

            // Step 1: AI Faction Decisions (simulated)
            const aiDecisions = getAIFactionDecisions(currentYear, currentMonth);

            // Step 2: Calculate tension changes based on multiple factors
            const tensionChanges = calculateDynamicTensions(aiDecisions, currentYear);

            // Step 3: Apply tension changes
            for (let key in tensionChanges) {
                gameState.tensions[key] = Math.max(0, Math.min(100,
                    gameState.tensions[key] + tensionChanges[key]));
            }

            // Step 4: War intentions based on weighted factors, NOT fixed rate
            const japanFactors = {
                military: gameState.tensions.military_faction * 0.4,
                economic: gameState.tensions.economic_pressure * 0.2,
                nationalist: gameState.tensions.nationalist_sentiment * 0.2,
                international: (100 - gameState.tensions.international_pressure) * 0.1,
                random: (Math.random() - 0.5) * 10  // Can go UP or DOWN
            };

            const chinaFactors = {
                japan_threat: gameState.japanWarIntention * 0.3,
                internal_unity: (100 - gameState.tensions.internal_strife || 70) * 0.2,
                preparation: 20,
                random: (Math.random() - 0.5) * 8
            };

            // Calculate new intentions with smoothing
            const newJapanIntention = Object.values(japanFactors).reduce((a, b) => a + b, 0);
            const newChinaReadiness = Object.values(chinaFactors).reduce((a, b) => a + b, 0);

            // Smooth transitions to prevent wild swings
            gameState.japanWarIntention = 0.7 * gameState.japanWarIntention + 0.3 * newJapanIntention;
            gameState.chinaWarReadiness = 0.8 * gameState.chinaWarReadiness + 0.2 * newChinaReadiness;

            // Factor in player decisions with stronger effect
            if (gameState.lastDecision) {
                // Emperor actions affect Japan's intention
                if (gameState.selectedRole === 'emperor') {
                    if (gameState.lastDecision === 'do_nothing') {
                        gameState.japanWarIntention += 2;  // Military acts unchecked
                    } else if (gameState.lastDecision === 'diplomatic' || gameState.lastDecision === 'rally_moderates') {
                        gameState.japanWarIntention -= 8;  // Strong peace effort
                    } else if (gameState.lastDecision === 'restraint') {
                        gameState.japanWarIntention -= 4;  // Moderate restraint
                    } else if (gameState.lastDecision === 'support_military') {
                        gameState.japanWarIntention += 8;  // Encourages militarism
                    } else if (gameState.lastDecision === 'dismiss_minister') {
                        gameState.japanWarIntention -= 6;  // Removes hawks
                    }
                }

                // Chiang actions affect China's readiness
                if (gameState.selectedRole === 'chiang') {
                    if (gameState.lastDecision.includes('military') || gameState.lastDecision.includes('suppress')) {
                        gameState.chinaWarReadiness += 6;
                        gameState.japanWarIntention += 3;  // Japan reacts
                    } else if (gameState.lastDecision.includes('diplomatic') || gameState.lastDecision.includes('concession')) {
                        gameState.chinaWarReadiness -= 4;
                        gameState.japanWarIntention -= 2;  // Reduces tensions
                    } else if (gameState.lastDecision.includes('unite') || gameState.lastDecision.includes('coalition')) {
                        gameState.chinaWarReadiness += 4;  // United but defensive
                    }
                }
            }

            // Apply Emperor influence modifier
            if (gameState.selectedRole === 'emperor' && gameState.emperorInfluence > 0) {
                // Higher influence = more control over military
                const influenceMod = (gameState.emperorInfluence - 30) / 20;  // -1.5 to +1.5
                gameState.japanWarIntention -= influenceMod;
            }

            // Ensure values stay in bounds
            gameState.japanWarIntention = Math.min(100, Math.max(0, gameState.japanWarIntention));
            gameState.chinaWarReadiness = Math.min(100, Math.max(0, gameState.chinaWarReadiness));

            return {
                japanWarIntention: Math.round(gameState.japanWarIntention),
                chinaWarReadiness: Math.round(gameState.chinaWarReadiness),
                coalitions: [
                    { name: 'ÂúãÊ∞ëÊîøÂ∫úËÅØÁõü', members: 'Ëî£‰ªãÁü≥, ÂÆãÂ≠êÊñá', power: 45 },
                    { name: 'ÂåóÊñπËªçÈñ•ËÅØÁõü', members: 'ÈñªÈå´Â±±, È¶ÆÁéâÁ••', power: 30 },
                    { name: 'ÂÖ±Áî¢Èª®Ê∏∏ÊìäÈöä', members: 'ÊØõÊæ§Êù±, Âë®ÊÅ©‰æÜ', power: 15 }
                ],
                factions: [
                    { name: 'Ëî£‰ªãÁü≥Ê¥æ', focus: 'ÂÖßÊà∞ÂÑ™ÂÖà', stance: 'Ë¨πÊÖéÊäóÊó•' },
                    { name: 'ÂÖ±Áî¢Èª®', focus: 'ÊäóÊó•Áµ±‰∏ÄÊà∞Á∑ö', stance: 'Á©çÊ•µÊäóÊó•' },
                    { name: 'ÂºµÂ≠∏ËâØ', focus: '‰øùË°õÊù±Âåó', stance: 'Âº∑Á°¨ÊäóÊó•' },
                    { name: 'Âª£Ë•øÊ¥æÁ≥ª', focus: 'Âú∞ÊñπËá™Ê≤ª', stance: '‰∏≠Á´ãËßÄÊúõ' }
                ]
            };
        }

        function updateMetrics() {
            document.getElementById('peaceScore').textContent = Math.round(gameState.metrics.peace);
            document.getElementById('diplomacyScore').textContent = Math.round(gameState.metrics.diplomacy);
            document.getElementById('reputationScore').textContent = Math.round(gameState.metrics.reputation);
            document.getElementById('stabilityScore').textContent = Math.round(gameState.metrics.stability);
            document.getElementById('warIntentionScore').textContent = Math.round(gameState.warIntention);

            document.getElementById('peaceProgress').style.width = gameState.metrics.peace + '%';
            document.getElementById('diplomacyProgress').style.width = Math.min(100, gameState.metrics.diplomacy) + '%';
            document.getElementById('reputationProgress').style.width = gameState.metrics.reputation + '%';
            document.getElementById('stabilityProgress').style.width = gameState.metrics.stability + '%';
            document.getElementById('warIntentionProgress').style.width = gameState.warIntention + '%';

            // Update progress bar colors based on values
            const peaceColor = gameState.metrics.peace > 70 ? '#28a745' : gameState.metrics.peace > 40 ? '#ffc107' : '#dc3545';
            document.getElementById('peaceProgress').style.background = `linear-gradient(45deg, ${peaceColor}, ${peaceColor}dd)`;

            // Update war intention color
            const warIntentionBar = document.getElementById('warIntentionProgress');
            if (gameState.warIntention >= 90) {
                warIntentionBar.style.background = 'linear-gradient(45deg, #dc3545, #721c24)';
            } else if (gameState.warIntention >= 70) {
                warIntentionBar.style.background = 'linear-gradient(45deg, #ffc107, #dc3545)';
            } else if (gameState.warIntention >= 50) {
                warIntentionBar.style.background = 'linear-gradient(45deg, #28a745, #ffc107)';
            } else {
                warIntentionBar.style.background = 'linear-gradient(45deg, #20c997, #28a745)';
            }
        }

        function addEvent(title, description) {
            const eventsList = document.getElementById('eventsList');
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.innerHTML = `
                <div class="event-time">Á¨¨${gameState.currentTurn}ÂõûÂêà - ${title}</div>
                <div>${description}</div>
            `;
            eventsList.appendChild(eventItem);
            eventsList.scrollTop = eventsList.scrollHeight;
        }

        function showLoading(show, isNewTurn = false) {
            const loadingState = document.getElementById('loadingState');
            const loadingProgress = document.getElementById('loadingProgress');
            const currentPlayerThinking = document.getElementById('currentPlayerThinking');

            if (show) {
                loadingState.style.display = 'block';

                // Reset and restart progress animation
                loadingProgress.style.animation = 'none';
                loadingProgress.offsetHeight; // Trigger reflow
                loadingProgress.style.animation = 'progressAnimation 15s ease-in-out';

                // Show who's thinking in default mode
                if (gameState.selectedMode === 'default') {
                    const opponents = {
                        emperor: ['‰∏≠ÂúãËªçÈÉ®', '‰∏≠ÂÖ±Âã¢Âäõ', 'ÂúãÈöõËßÄÂØüÂÆ∂'],
                        chiang: ['Êó•Êú¨ËªçÈÉ®', 'ÈóúÊù±Ëªç', 'Êó•Êú¨Ë≤°Èñ•']
                    };
                    const currentOpponents = opponents[gameState.selectedRole] || [];
                    const randomOpponent = currentOpponents[Math.floor(Math.random() * currentOpponents.length)];
                    currentPlayerThinking.textContent = isNewTurn ? `${randomOpponent} Ê≠£Âú®Ë©ï‰º∞Â±ÄÂã¢...` : '';
                } else {
                    currentPlayerThinking.textContent = '';
                }
            } else {
                loadingState.style.display = 'none';
                currentPlayerThinking.textContent = '';
            }
        }

        function checkEndConditions() {
            // Calculate years passed
            const yearsPassed = Math.floor(gameState.currentTurn / 12);
            const currentYear = gameState.startYear + yearsPassed;

            // Victory: Maintain peace until 1940
            if (currentYear >= 1940) {
                if (gameState.warIntention < 90) {  // Not in total war
                    return 'peace_achieved';
                }
            }

            // Peace failed - war inevitable
            if (gameState.warIntention >= 90) {
                return 'peace_failed';  // Total war threshold
            }

            // Check if reached max turns without war
            if (gameState.currentTurn >= gameState.maxTurns) {
                if (gameState.warIntention < 70) {
                    return 'temporary_peace';
                } else {
                    return 'unstable_peace';
                }
            }

            return false;
        }

        function endSimulation() {
            const endCondition = checkEndConditions();
            let finalMessage = '';
            let resultClass = '';

            if (endCondition === 'peace_achieved') {
                finalMessage = 'üéâ ÊÅ≠ÂñúÔºÅÊÇ®ÊàêÂäüÈòªÊ≠¢‰∫ÜÊà∞Áà≠ÁöÑÁàÜÁôºÔºåÂØ¶Áèæ‰∫ÜÂíåÂπ≥ÔºÅÊÇ®ÁöÑÂ§ñ‰∫§Êô∫ÊÖßÊãØÊïë‰∫ÜÁÑ°Êï∏ÁîüÂëΩ„ÄÇ';
                resultClass = 'success';
            } else if (endCondition === 'peace_failed') {
                finalMessage = 'üòî ÂæàÈÅ∫ÊÜæÔºåÂ§ñ‰∫§Âä™ÂäõÂ§±ÊïóÔºåÊà∞Áà≠‰∏çÂèØÈÅøÂÖç„ÄÇ‰ΩÜÊÇ®ÁöÑÂòóË©¶‰ªçÊúâÊÑèÁæ©ÔºåÂíåÂπ≥‰πãË∑ØÂæû‰æÜ‰∏çÊòì„ÄÇ';
                resultClass = 'failure';
            } else if (gameState.metrics.peace >= 60) {
                finalMessage = 'ü§ù ÊÇ®ÈÅîÊàê‰∫ÜÈÉ®ÂàÜÂíåÂπ≥ÁõÆÊ®ô„ÄÇÈõñÊú™ÂÆåÂÖ®ÈòªÊ≠¢Ë°ùÁ™ÅÔºå‰ΩÜÈ°ØËëóÈôç‰Ωé‰∫ÜÊà∞Áà≠Ë¶èÊ®°„ÄÇ';
                resultClass = 'partial';
            } else {
                finalMessage = '‚öñÔ∏è Â±ÄÂã¢Ë§áÈõúÔºåÁµêÊûúÂñúÊÜÇÂèÉÂçä„ÄÇÊ≠∑Âè≤Ë≠âÊòéÔºåÂíåÂπ≥ÈúÄË¶ÅÂêÑÊñπÁöÑÂÖ±ÂêåÂä™Âäõ„ÄÇ';
                resultClass = 'mixed';
            }

            // Display final results
            const resultPanel = document.createElement('div');
            resultPanel.className = `situation-panel ${resultClass}`;
            resultPanel.innerHTML = `
                <div class="situation-title">
                    üèÜ Ê®°Êì¨ÁµêÊûú
                </div>
                <div style="font-size: 1.2rem; margin-bottom: 20px;">${finalMessage}</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div>ÊúÄÁµÇÂíåÂπ≥ÂàÜÊï∏: <strong>${Math.round(gameState.metrics.peace)}/100</strong></div>
                    <div>Â§ñ‰∫§ÊàêÂäüÂ∫¶: <strong>${Math.round(gameState.metrics.diplomacy)}</strong></div>
                    <div>ÂúãÈöõËÅ≤Êúõ: <strong>${Math.round(gameState.metrics.reputation)}/100</strong></div>
                    <div>ÂÖßÈÉ®Á©©ÂÆö: <strong>${Math.round(gameState.metrics.stability)}/100</strong></div>
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="location.reload()" style="padding: 10px 30px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        üîÑ ÈáçÊñ∞ÈñãÂßãÊ®°Êì¨
                    </button>
                    <button onclick="downloadResults()" style="padding: 10px 30px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px;">
                        üíæ ‰∏ãËºâÁµêÊûúÂ†±Âëä
                    </button>
                </div>
            `;
            
            document.getElementById('situationPanel').replaceWith(resultPanel);
        }

        function updateWarIntention(decision) {
            // Simulate BDM model effects on war intention
            const warEffects = {
                emperor: {
                    do_nothing: 3,  // Military acts more freely
                    diplomatic: -5,
                    restraint: -3,
                    support_military: 8,
                    dismiss_minister: -4,
                    rally_moderates: -6
                },
                chiang: {
                    diplomatic: -8,
                    military_preparation: 10,
                    unite_communists: 5,
                    international_appeal: -3,
                    local_concession: -10,
                    mobilize_nationalism: 15
                }
            };

            const effects = warEffects[gameState.selectedRole] || {};
            const change = effects[decision] || 0;

            // Add random variation to simulate faction dynamics
            const variation = (Math.random() - 0.5) * 5;

            gameState.warIntention = Math.max(0, Math.min(100,
                gameState.warIntention + change + variation));

            // Update war intention display
            document.getElementById('warIntentionScore').textContent = Math.round(gameState.warIntention);
            document.getElementById('warIntentionProgress').style.width = gameState.warIntention + '%';

            // Change color based on danger level
            const progressBar = document.getElementById('warIntentionProgress');
            if (gameState.warIntention >= 90) {
                progressBar.style.background = 'linear-gradient(45deg, #dc3545, #721c24)';
            } else if (gameState.warIntention >= 70) {
                progressBar.style.background = 'linear-gradient(45deg, #ffc107, #dc3545)';
            } else if (gameState.warIntention >= 50) {
                progressBar.style.background = 'linear-gradient(45deg, #28a745, #ffc107)';
            } else {
                progressBar.style.background = 'linear-gradient(45deg, #20c997, #28a745)';
            }
        }

        function updateEmperorInfluence(decision) {
            const influenceCosts = {
                do_nothing: 0,
                diplomatic: -3,
                restraint: -2,
                support_military: 2,  // Gains influence by supporting military
                dismiss_minister: -5,
                rally_moderates: -1
            };

            const cost = influenceCosts[decision] || 0;
            gameState.emperorInfluence = Math.max(5, Math.min(50,
                gameState.emperorInfluence + cost));

            // Positive outcomes can restore some influence
            if (gameState.metrics.peace > 70 && Math.random() > 0.7) {
                gameState.emperorInfluence = Math.min(50, gameState.emperorInfluence + 1);
            }
        }

        function showDecisionPanel() {
            document.getElementById('decisionPanel').style.display = 'block';

            // Update decision description based on role
            const descriptions = {
                emperor: `Ë∫´ÁÇ∫Â§©ÁöáÔºåÊÇ®ÊìÅÊúâÈÅìÂæ∑Ê¨äÂ®Å‰ΩÜ‰∏çÊáâÁõ¥Êé•Âπ≤È†êÊîøÂ∫ú„ÄÇÁï∂ÂâçÂΩ±ÈüøÂäõÔºö${gameState.emperorInfluence.toFixed(0)}/50„ÄÇÊØèÊ¨°Âπ≤È†êÊúÉÊ∂àËÄóÂΩ±ÈüøÂäõ„ÄÇ`,
                chiang: `‰ΩúÁÇ∫‰∏≠ËèØÊ∞ëÂúãÈ†òË¢ñÔºåÊÇ®ÂøÖÈ†àÂπ≥Ë°°Â§öÊñπÂã¢Âäõ„ÄÇÁï∂ÂâçÊà∞Áà≠ÂÇæÂêëÔºö${gameState.warIntention.toFixed(0)}/100„ÄÇ`
            };

            document.getElementById('decisionDescription').textContent = descriptions[gameState.selectedRole];

            // Generate decision options based on role
            generateDecisionOptions();
        }

        function generateDecisionOptions() {
            const optionsContainer = document.getElementById('decisionOptions');
            optionsContainer.innerHTML = '';

            let options = [];
            if (gameState.selectedRole === 'emperor') {
                options = [
                    { id: 'do_nothing', icon: 'ü§ê', title: '‰øùÊåÅÊ≤âÈªò', desc: '‰∏çÂπ≤È†êÊîøÂ∫ú‰∫ãÂãôÔºà‰∏çÊ∂àËÄóÂΩ±ÈüøÂäõÔºâ', cost: 0 },
                    { id: 'diplomatic', icon: 'üïäÔ∏è', title: 'ÂíåÂπ≥ËÅ≤Êòé', desc: 'ÂÖ¨ÈñãÂëºÁ±≤Â§ñ‰∫§Ëß£Ê±∫', cost: 3 },
                    { id: 'restraint', icon: '‚úã', title: 'ÁßÅ‰∏ãÂã∏Âëä', desc: 'ÁßÅ‰∏ãË¶ÅÊ±ÇËªçÈÉ®ÂÖãÂà∂', cost: 2 },
                    { id: 'support_military', icon: '‚öîÔ∏è', title: 'ÊîØÊåÅËªçÈÉ®', desc: 'ÊîØÊåÅ„ÄåÈò≤Á¶¶ÊÄß„ÄçË°åÂãï', cost: -2 },
                    { id: 'dismiss_minister', icon: 'üö´', title: 'Êí§ÊèõÂ§ßËá£', desc: 'Ë°å‰ΩøÊ¨äÂäõÊí§ÊèõÊøÄÈÄ≤Â§ßËá£', cost: 5 },
                    { id: 'rally_moderates', icon: 'ü§ù', title: 'Âè¨ÈõÜÊ∫´ÂíåÊ¥æ', desc: 'ÁµÑÁπîÊ∫´ÂíåÊ¥æÂïÜË®éÂíåÂπ≥', cost: 1 }
                ];
            } else {
                // Rotate options based on turn to show different domestic/external challenges
                const turnMod = gameState.currentTurn % 3;
                if (turnMod === 0) {
                    // Focus on Japan
                    options = [
                        { id: 'diplomatic', icon: 'üïäÔ∏è', title: 'Â∞çÊó•Ë´áÂà§', desc: 'ÊèêË≠∞ËàáÊó•Êú¨Áõ¥Êé•Ë´áÂà§' },
                        { id: 'military_preparation', icon: 'üõ°Ô∏è', title: 'Ëªç‰∫ãÊ∫ñÂÇô', desc: 'Âä†Âº∑Ëªç‰∫ãÊ∫ñÂÇôÔºåÂ±ïÁ§∫Ê±∫ÂøÉ' },
                        { id: 'international_appeal', icon: 'üåê', title: 'ÂúãÈöõÊ±ÇÊè¥', desc: 'ÂêëÂúãÈöõÁ§æÊúÉÊ±ÇÂä©' },
                        { id: 'local_concession', icon: '‚öñÔ∏è', title: 'Â±ÄÈÉ®ËÆìÊ≠•', desc: 'Â±ÄÈÉ®ËÆìÊ≠•ÈÅøÂÖçÂÖ®Èù¢Êà∞Áà≠' }
                    ];
                } else if (turnMod === 1) {
                    // Focus on Communists
                    options = [
                        { id: 'unite_communists', icon: 'ü§ù', title: 'ËÅØÂÖ±ÊäóÊó•', desc: 'ÂÅúÊ≠¢ÂâøÂÖ±ÔºåÂÖ±ÂêåÊäóÊó•' },
                        { id: 'suppress_communists', icon: '‚öîÔ∏è', title: 'ÁπºÁ∫åÂâøÂÖ±', desc: 'ÂÖàÂÆâÂÖßÂæåÊîòÂ§ñ' },
                        { id: 'negotiate_ceasefire', icon: '‚úã', title: 'Êö´ÊôÇÂÅúÁÅ´', desc: 'ËàáÂÖ±Áî¢Èª®Êö´ÊôÇÂÅúÁÅ´' },
                        { id: 'mobilize_nationalism', icon: 'üì¢', title: 'Ê∞ëÊóèÂúòÁµê', desc: 'ÂëºÁ±≤ÂêÑÊ¥æÂúòÁµêÊäóÊó•' }
                    ];
                } else {
                    // Focus on Warlords
                    options = [
                        { id: 'negotiate_warlords', icon: 'ü§ù', title: 'Êï¥ÂêàËªçÈñ•', desc: 'ËàáÂú∞ÊñπËªçÈñ•Ë´áÂà§Áµ±‰∏Ä' },
                        { id: 'bribe_warlords', icon: 'üí∞', title: 'Âà©Ë™òËªçÈñ•', desc: 'Áî®Ë≥áÊ∫êÊèõÂèñÊïàÂø†' },
                        { id: 'centralize_power', icon: 'üëë', title: '‰∏≠Â§ÆÈõÜÊ¨ä', desc: 'ÂâäÂº±Âú∞ÊñπÂã¢Âäõ' },
                        { id: 'coalition_building', icon: 'üèõÔ∏è', title: 'Âª∫Á´ãËÅØÁõü', desc: 'ÁµÑÂª∫ÊäóÊó•Áµ±‰∏ÄÊà∞Á∑ö' }
                    ];
                }
            }

            options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'decision-option';
                optionDiv.dataset.option = option.id;

                let costDisplay = '';
                if (gameState.selectedRole === 'emperor' && option.cost !== undefined) {
                    const influenceColor = option.cost > 0 ? '#dc3545' : option.cost < 0 ? '#28a745' : '#6c757d';
                    costDisplay = `<div style="font-size: 0.8rem; color: ${influenceColor}; margin-top: 5px;">ÂΩ±ÈüøÂäõÔºö${option.cost > 0 ? '-' : '+'}${Math.abs(option.cost)}</div>`;
                }

                optionDiv.innerHTML = `
                    <strong>${option.icon} ${option.title}</strong>
                    <p>${option.desc}</p>
                    ${costDisplay}
                `;

                // Disable if Emperor doesn't have enough influence
                if (gameState.selectedRole === 'emperor' && option.cost > 0 && gameState.emperorInfluence < option.cost) {
                    optionDiv.style.opacity = '0.5';
                    optionDiv.style.cursor = 'not-allowed';
                    optionDiv.title = 'ÂΩ±ÈüøÂäõ‰∏çË∂≥';
                } else {
                    optionDiv.addEventListener('click', function() {
                        selectDecisionOption(this.dataset.option);
                    });
                }

                optionsContainer.appendChild(optionDiv);
            });
        }

        function downloadResults() {
            const results = {
                role: gameState.selectedRole,
                mode: gameState.selectedMode,
                turns: gameState.currentTurn,
                finalMetrics: gameState.metrics,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(results, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `peace_simulation_results_${Date.now()}.json`;
            link.click();
        }
        // Enhanced simulation functions
        function generateAIThoughts(year, month, playerRole) {
            const thoughts = {
                1930: {
                    "Áµ±Âà∂Ê¥æ": ["Á∂ìÊøüÂç±Ê©üÊòØÊì¥ÂºµÁöÑÊ©üÊúÉÔºå‰ΩÜÈúÄË¨πÊÖéË¶èÂäÉ", "ÊáâÂÖàÂú®ÊªøÊ¥≤Âª∫Á´ãÂü∫Âú∞ËÄåÈùûÂÖ®Èù¢ÈñãÊà∞", "Êµ∑ËªçÊ¢ùÁ¥ÑÈôêÂà∂‰∫ÜÊàëÂÄëÁöÑÁôºÂ±ï"],
                    "ÈóúÊù±Ëªç": ["Áü≥ÂéüËéûÁàæÊ≠£Âà∂ÂÆöÊªøËíôÈ†òÊúâË´ñ", "ÂºµÂ≠∏ËâØÁöÑÊù±ÂåóËªçÊòØ‰∏ªË¶ÅÈöúÁ§ô", "ÈúÄË¶ÅË£ΩÈÄ†‰∫ã‰ª∂‰ΩúÁÇ∫Ë°åÂãïËóâÂè£"],
                    "Ë≤°Èñ•": ["Á∂ìÊøüËï≠Ê¢ùÂΩ±ÈüøÂá∫Âè£ÔºåÈúÄË¶ÅÊñ∞Â∏ÇÂ†¥", "Êà∞Áà≠È¢®Èö™ÈÅéÂ§ßÔºåÊáâÂ∞àÊ≥®Ë≤øÊòì", "ÁæéÂúãÂ∏ÇÂ†¥Ëá≥ÈóúÈáçË¶Å"],
                    "‰∏≠ÂÖ±": ["Á¥ÖËªçÂú®Ê±üË•øÂª∫Á´ãËòáÂçÄ", "Âà©Áî®Ê∞ëÊóèÂç±Ê©üÂ£ØÂ§ßÂäõÈáè", "ÂúãÊ∞ëÈª®ÂúçÂâøÊòØ‰∏ªË¶ÅÂ®ÅËÑÖ"],
                    "ÂúãÊ∞ëÈª®": ["ÂøÖÈ†àÂÖàÂÆâÂÖßÂæåÊîòÂ§ñ", "Êó•Êú¨ÈáéÂøÉÊòéÈ°Ø‰ΩÜËªçÂäõ‰∏çË∂≥", "ÈúÄË¶ÅÊôÇÈñìÈÄ≤Ë°åÁèæ‰ª£Âåñ"]
                },
                1931: {
                    "Áµ±Âà∂Ê¥æ": ["‰∏âÊúà‰∫ã‰ª∂È°ØÁ§∫ÈúÄË¶ÅÊõ¥Ë¨πÊÖé", "ÈóúÊù±ËªçÂèØËÉΩËá™‰∏ªË°åÂãï", "‰πù‰∏ÄÂÖ´ÊôÇÊ©üÂ∑≤ÊàêÁÜü"],
                    "ÈóúÊù±Ëªç": ["Êü≥Ê¢ùÊπñË®àÂäÉÂ∑≤Ê∫ñÂÇôÂ∞±Á∑í", "Êù±‰∫¨Áå∂Ë±´‰ª§‰∫∫Ê≤ÆÂñ™", "ÂøÖÈ†àËá™‰∏ªË°åÂãï"],
                    "‰∏≠ÂÖ±": ["Èï∑ÂæÅÊ∫ñÂÇô‰∏≠", "ËàáÂúãÊ∞ëÈª®È¨•Áà≠ÊòØ‰∏ªÁ∑ö", "Êó•Êú¨‰æµÁï•ÊòØÊ¨°Ë¶ÅÁüõÁõæ"]
                },
                1936: {
                    "Áµ±Âà∂Ê¥æ": ["‰∫å‰∫åÂÖ≠ÂæåÂÆåÂÖ®ÊéßÂà∂ËªçÈÉ®", "Â∞çËèØÊà∞Áà≠Ê∫ñÂÇôÂ∞±Á∑í", "Ë•øÂÆâ‰∫ãËÆäÊîπËÆäÂ±ÄÂã¢"],
                    "ÂúãÊ∞ëÈª®": ["ÂøÖÈ†àËÅØÂÖ±ÊäóÊó•", "Âæ∑ÂúãÈ°ßÂïèÂçîÂä©Ëªç‰∫ãÁèæ‰ª£Âåñ", "‰∏äÊµ∑ÊòØÈò≤Á¶¶ÈáçÈªû"]
                },
                1937: {
                    "Áµ±Âà∂Ê¥æ": ["ÁõßÊ∫ùÊ©ãÂèØ‰ΩúÁÇ∫ÈñãÊà∞ËóâÂè£", "ÈÄüÊà∞ÈÄüÊ±∫ÊòØÈóúÈçµ", "‰∏≠ÂúãÊäµÊäóÂäõË¢´‰Ωé‰º∞"],
                    "ÂúãÊ∞ëÈª®": ["ÂÖ®Èù¢ÊäóÊà∞‰∏çÂèØÈÅøÂÖç", "Á©∫ÈñìÊèõÊôÇÈñìÁ≠ñÁï•", "ÂúãÈöõÊîØÊè¥Ëá≥ÈóúÈáçË¶Å"]
                }
            };

            const yearThoughts = thoughts[year] || thoughts[1930];
            const result = [];
            for (let agent in yearThoughts) {
                const agentThoughts = yearThoughts[agent];
                result.push({
                    agent: agent,
                    thought: agentThoughts[Math.floor(Math.random() * agentThoughts.length)]
                });
            }
            return result;
        }

        function generateRandomIncident(year, month, warIntention) {
            const incidents = [
                { minTension: 0, maxTension: 30, title: "ÈÇäÂ¢ÉËµ∞ÁßÅ‰∫ã‰ª∂", desc: "ÊªøÊ¥≤ÈÇäÂ¢ÉËµ∞ÁßÅË°ùÁ™Å", peaceEffect: -2, warEffect: 3 },
                { minTension: 20, maxTension: 50, title: "ÈñìË´úË¢´Êçï", desc: "Êó•Êú¨ÈñìË´úÂú®ËèØË¢´Êçï", peaceEffect: -5, warEffect: 8 },
                { minTension: 40, maxTension: 70, title: "Â£´ÂÖµË°ùÁ™Å", desc: "ÈÇäÂ¢ÉÂ∑°ÈÇèÈöä‰∫§ÁÅ´", peaceEffect: -8, warEffect: 12 },
                { minTension: 60, maxTension: 90, title: "ËªçÂÆòÊìÖËá™Ë°åÂãï", desc: "ÂâçÁ∑öËªçÂÆòÊú™Á∂ìÊéàÊ¨äÊîªÊìä", peaceEffect: -15, warEffect: 20 }
            ];

            if (Math.random() > 0.8) {
                const validIncidents = incidents.filter(i => warIntention >= i.minTension && warIntention < i.maxTension);
                if (validIncidents.length > 0) {
                    return validIncidents[Math.floor(Math.random() * validIncidents.length)];
                }
            }
            return null;
        }

        function generateDynamicNews(year, month, warIntention) {
            const templates = [
                `Á∂ìÊøüÔºöÂ§±Ê•≠Áéá${(15 + Math.random() * 10).toFixed(1)}%ÔºåÊ∞ëÁúæ${warIntention > 50 ? 'Ë¶ÅÊ±ÇÂº∑Á°¨' : 'ÊîØÊåÅÂíåÂπ≥'}`,
                `ËªçÈÉ®Ôºö${warIntention > 60 ? 'È∑πÊ¥æ' : 'Ê∫´ÂíåÊ¥æ'}ÂΩ±ÈüøÂäõ‰∏äÂçá`,
                `Â§ñ‰∫§Ôºö${warIntention < 40 ? 'ÂíåÂπ≥Ë´áÂà§ÊúâÈÄ≤Â±ï' : 'Â§ñ‰∫§Èóú‰øÇÊÉ°Âåñ'}`,
                `Ê∞ëÈñìÔºö${warIntention > 70 ? 'Êà∞Áà≠' : 'ÂíåÂπ≥'}ÊÉÖÁ∑íÈ´òÊº≤`
            ];
            return templates[Math.floor(Math.random() * templates.length)];
        }

        function getHistoricalContext(year, month) {
            const contexts = {
                1930: "Á∂ìÊøüÂ§ßËï≠Ê¢ùÂΩ±Èüø‰∫ûÊ¥≤„ÄÇÊó•Êú¨ËªçÂúã‰∏ªÁæ©Êä¨È†≠Ôºå‰∏≠ÂúãÂÖßÊà∞ÊåÅÁ∫å„ÄÇ",
                1931: "ÊªøÊ¥≤Â±ÄÂã¢Á∑äÂºµ„ÄÇ‰πù‰∏ÄÂÖ´‰∫ãËÆäÂèØËÉΩÁôºÁîü„ÄÇ",
                1932: "ÊªøÊ¥≤ÂúãÊàêÁ´ãÂïèÈ°å„ÄÇ‰∏Ä‰∫åÂÖ´‰∫ãËÆäÈ¢®Èö™„ÄÇ",
                1933: "Êó•Êú¨ÈÄÄÂá∫ÂúãËÅØ„ÄÇÈï∑ÂüéÊäóÊà∞ÂèØËÉΩ„ÄÇ",
                1934: "ËèØÂåóÂç±Ê©üÈÜûÈáÄ‰∏≠„ÄÇ",
                1935: "ËèØÂåóËá™Ê≤ªÈÅãÂãï„ÄÇ",
                1936: "‰∫å‰∫åÂÖ≠‰∫ã‰ª∂„ÄÇË•øÂÆâ‰∫ãËÆä„ÄÇ",
                1937: "ÁõßÊ∫ùÊ©ãÂ±ÄÂã¢Á∑äÂºµ„ÄÇ",
                1938: "Êà∞Áà≠Êì¥Â§ßÊàñÂíåÂπ≥ÈûèÂõ∫„ÄÇ",
                1939: "Ê≠êÊ¥≤Êà∞Èõ≤ÂØÜÂ∏É„ÄÇ",
                1940: "‰∏ñÁïåÂ§ßÊà∞ÂÖ®Èù¢ÁàÜÁôº„ÄÇ"
            };
            return contexts[year] || `${year}Âπ¥ÔºöÂ±ÄÂã¢ÁôºÂ±ï‰∏≠...`;
        }
    </script>
</body>
</html>
